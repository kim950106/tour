<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"/>
  <title>MBTI 관계도 | LS TourPass</title>
  <style>
    :root{
      --brand-start:#5b7cfa; --brand-end:#7a53c8;
      --ink:#0f172a; --muted:#64748b; --line:#e2e8f0;
    }
    *{box-sizing:border-box;margin:0;padding:0;-webkit-tap-highlight-color:transparent}
    html,body{height:100%}
    body{background:linear-gradient(135deg,var(--brand-start),var(--brand-end));font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,'Helvetica Neue',Arial,sans-serif;overflow:hidden}
    .app{display:flex;flex-direction:column;height:100%;max-width:820px;margin:0 auto;background:#fff;box-shadow:0 10px 30px rgba(0,0,0,.12)}
    .header{background:linear-gradient(135deg,var(--brand-start),var(--brand-end));color:#fff;padding:12px 14px;display:flex;align-items:center;justify-content:space-between}
    .title{font-weight:700;font-size:16px;display:flex;gap:8px;align-items:center}
    .mode-tabs{display:flex;gap:6px}
    .tab{padding:8px 10px;border-radius:999px;border:1px solid #fff22;background:transparent;color:#fff;cursor:pointer}
    .tab.active{background:#1e40af;border-color:#1e40af}
    .controls{padding:12px;border-bottom:1px solid var(--line);display:grid;gap:10px;background:#f8fafc}
    .row{display:flex;gap:8px;flex-wrap:wrap}
    .btn{appearance:none;border:0;border-radius:10px;padding:10px 12px;font-weight:700;cursor:pointer}
    .btn-primary{background:linear-gradient(135deg,#16a34a,#22c55e);color:#fff;min-width:140px}
    .btn-outline{background:#fff;border:2px solid #1e40af;color:#1e40af}
    .input,select{flex:1;min-width:120px;background:#fff;border:2px solid var(--line);border-radius:10px;padding:10px 12px;font-size:14px}
    .helper{font-size:12px;color:var(--muted)}
    .viz-wrap{position:relative;flex:1;min-height:420px;overflow:hidden;background:linear-gradient(135deg,#fff6fb,#eef7ff)}
    #wires{position:absolute;inset:0;z-index:1;display:block}
    #stage{position:absolute;inset:0;z-index:2}
    .legend{display:flex;gap:12px;flex-wrap:wrap;padding:8px 12px;border-top:1px solid var(--line);background:#fff}
    .legend-item{display:flex;align-items:center;gap:6px;font-size:12px}
    .legend-dot{width:18px;height:4px;border-radius:4px;display:inline-block}
    .stats{display:grid;grid-template-columns:repeat(3,1fr);gap:8px;padding:10px 12px;background:#fff;border-top:1px solid var(--line)}
    .stat{background:linear-gradient(180deg,#f6f7fb,#eaeef7);border-radius:10px;padding:8px;text-align:center}
    .stat .v{font-weight:800}
    .stat .k{font-size:11px;color:#64748b}
    .bottomsheet{position:fixed;left:0;right:0;bottom:-100%;background:#fff;border-top-left-radius:16px;border-top-right-radius:16px;box-shadow:0 -10px 30px rgba(0,0,0,.18);padding:16px;transition:bottom .25s ease;z-index:50;max-width:820px;margin:0 auto}
    .bottomsheet.show{bottom:0}
    .sheet-head{display:flex;justify-content:space-between;align-items:center;margin-bottom:10px}
    .sheet-title{font-weight:800}
    .x{width:34px;height:34px;display:grid;place-items:center;border-radius:50%;border:1px solid var(--line);background:#fff;cursor:pointer}
    @keyframes pulse {0%,100%{transform:scale(1)}50%{transform:scale(1.05)}}
  </style>
</head>
<body>
  <div class="app">
    <div class="header">
      <div class="title">🌟 MBTI 관계도</div>
      <div class="mode-tabs" role="tablist" aria-label="배치 모드">
        <button class="tab active" id="mode-circle">원형 배치</button>
        <button class="tab" id="mode-grid">격자 배치</button>
      </div>
    </div>

    <div class="controls">
      <div class="row">
        <button id="btn-load" class="btn btn-primary">👥 관계도 불러오기</button>
        <button id="btn-reset" class="btn btn-outline">초기화</button>
      </div>
      <div class="row">
        <input id="myName" class="input" placeholder="내 이름(선택)"/>
        <select id="myMbti" class="input">
          <option value="">내 MBTI 선택</option>
          <option>INTJ</option><option>INTP</option><option>ENTJ</option><option>ENTP</option>
          <option>INFJ</option><option>INFP</option><option>ENFJ</option><option>ENFP</option>
          <option>ISTJ</option><option>ISFJ</option><option>ESTJ</option><option>ESFJ</option>
          <option>ISTP</option><option>ISFP</option><option>ESTP</option><option>ESFP</option>
        </select>
        <button id="btn-me" class="btn btn-primary">⭐ 내 기준 관계도 보기</button>
      </div>
      <div class="helper">* 검색/필터/데이터정제 UI는 요청에 따라 제거했습니다. 선 연결은 자동 표시됩니다.</div>
    </div>

    <div class="viz-wrap">
      <svg id="wires" xmlns="http://www.w3.org/2000/svg"></svg>
      <div id="stage" aria-live="polite"></div>
    </div>

    <div class="legend">
      <div class="legend-item"><span class="legend-dot" style="background:#22c55e"></span>최고</div>
      <div class="legend-item"><span class="legend-dot" style="background:#3b82f6"></span>좋음</div>
      <div class="legend-item"><span class="legend-dot" style="background:#f59e0b"></span>보통</div>
      <div class="legend-item"><span class="legend-dot" style="background:#ef4444"></span>도전적</div>
    </div>

    <div class="stats">
      <div class="stat"><div class="v" id="totalCount">0</div><div class="k">총 인원</div></div>
      <div class="stat"><div class="v" id="excellentCount">-</div><div class="k">최고 궁합</div></div>
      <div class="stat"><div class="v" id="challengingCount">-</div><div class="k">도전적</div></div>
    </div>

    <div id="sheet" class="bottomsheet" role="dialog" aria-modal="true" aria-labelledby="sheetTitle">
      <div class="sheet-head">
        <div class="sheet-title" id="sheetTitle">상세</div>
        <button class="x" id="sheetClose" aria-label="닫기">✕</button>
      </div>
      <div id="sheetBody" style="font-size:14px;line-height:1.7"></div>
    </div>
  </div>

  <script>
    // ===== 설정 =====
    const SHEET_URL = "https://script.google.com/macros/s/AKfycbxgPR8R0tD-eLfWV2tLcaI4SF9sCMh6tJhlYls4Yfzp84EbnoJEhJNShlmTHRqpTb-C/exec";
    const MAX_NODES = 30;

    const mbtiEmojis = {INTJ:"🧙", INTP:"🤖", ENTJ:"👑", ENTP:"💡", INFJ:"🦄", INFP:"🧚", ENFJ:"⭐", ENFP:"🦋", ISTJ:"📚", ISFJ:"🧸", ESTJ:"💼", ESFJ:"🤗", ISTP:"🔧", ISFP:"🎨", ESTP:"🏃", ESFP:"🎉"};
    const mbtiColor  = {INTJ:"#667eea", INTP:"#f093fb", ENTJ:"#4facfe", ENTP:"#43e97b", INFJ:"#fa709a", INFP:"#30cfd0", ENFJ:"#a8edea", ENFP:"#ff9a9e", ISTJ:"#fbc2eb", ISFJ:"#fddb92", ESTJ:"#f6d365", ESFJ:"#fccb90", ISTP:"#a1c4fd", ISFP:"#d4fc79", ESTP:"#84fab0", ESFP:"#fc5c7d"};
    const comp = {
      INTJ:{excellent:["ENFP","ENTP"],good:["INFJ","INFP","ENFJ"],neutral:["INTJ","ENTJ","INTP","ESTP","ISTP","ISFP"],challenging:["ISFJ","ESFJ","ISTJ","ESFP","ESTJ"]},
      INTP:{excellent:["ENTJ","ESTJ"],good:["INTJ","ENTP","INFJ"],neutral:["INTP","ENFP","INFP","ENFJ","ISTP","ISFP"],challenging:["ISFJ","ESFJ","ISTJ","ESTP","ESFP"]},
      ENTJ:{excellent:["INTP","INTJ"],good:["ENTP","ENFJ","ENTJ"],neutral:["INFJ","INFP","ENFP","ESTJ","ISTP","ESTP"],challenging:["ISFJ","ESFJ","ISTJ","ISFP","ESFP"]},
      ENTP:{excellent:["INFJ","INTJ"],good:["ENFP","ENFJ","ENTJ","INTP"],neutral:["ENTP","INFP","ESTP","ISTP"],challenging:["ISFJ","ESFJ","ISTJ","ISFP","ESFP","ESTJ"]},
      INFJ:{excellent:["ENTP","ENFP"],good:["INTJ","INFJ","INTP","ENFJ"],neutral:["INFP","ENTJ","ISFJ","ISTJ"],challenging:["ESTP","ESFP","ISTP","ESFJ","ISFP","ESTJ"]},
      INFP:{excellent:["ENFJ","ENTJ"],good:["INFJ","INTJ","INTP","ENFP"],neutral:["INFP","ENTP","ISFP","ISFJ"],challenging:["ESTP","ESFP","ISTP","ESFJ","ISTJ","ESTJ"]},
      ENFJ:{excellent:["INFP","ISFP"],good:["ENFP","INFJ","ENFJ","INTJ","ENTJ"],neutral:["ENTP","INTP","ESFJ","ISFJ"],challenging:["ESTP","ESFP","ISTP","ISTJ","ESTJ"]},
      ENFP:{excellent:["INTJ","INFJ"],good:["ENTJ","ENTP","ENFJ","INFP"],neutral:["ENFP","INTP","ESFP","ISFP"],challenging:["ISTP","ESTP","ISFJ","ISTJ","ESFJ","ESTJ"]},
      ISTJ:{excellent:["ESFP","ESTP"],good:["ISFJ","ISTJ","ESTJ","ESFJ"],neutral:["INTJ","INTP","INFJ","ISTP"],challenging:["INFP","ENFP","ENFJ","ENTP","ENTJ","ISFP"]},
      ISFJ:{excellent:["ESFP","ESTP"],good:["ISFJ","ESFJ","ISTJ","ESTJ"],neutral:["INFJ","INFP","ENFJ","ISFP"],challenging:["INTJ","INTP","ENTP","ENTJ","ENFP","ISTP"]},
      ESTJ:{excellent:["ISFP","ISTP"],good:["ISTJ","ESFJ","ISFJ","ESTJ"],neutral:["ENTJ","INTP","ESTP","ESFP"],challenging:["INFJ","INFP","ENFJ","ENFP","INTJ","ENTP"]},
      ESFJ:{excellent:["ISFP","ISTP"],good:["ESFJ","ISFJ","ESTJ","ISTJ"],neutral:["ENFJ","ISFP","ESFP","ESTP"],challenging:["INFJ","INFP","ENFP","INTJ","INTP","ENTP","ENTJ"]},
      ISTP:{excellent:["ESFJ","ESTJ"],good:["INTJ","INTP","ESTP","ISTP"],neutral:["ENTJ","ENTP","ISFJ","ISTJ","ISFP"],challenging:["INFJ","INFP","ENFP","ENFJ","ESFP"]},
      ISFP:{excellent:["ENFJ","ESFJ","ESTJ"],good:["ISFJ","ESFP","ISFP"],neutral:["INTJ","INTP","INFP","ENFP","ISTP","ISTJ"],challenging:["INFJ","ENTJ","ENTP","ESTP"]},
      ESTP:{excellent:["ISFJ","ISTJ"],good:["ESFP","ISTP","ESTP","ESFJ"],neutral:["ENTJ","ENTP","INTJ","ESTJ"],challenging:["INFJ","INFP","ENFJ","ENFP","INTP","ISFP"]},
      ESFP:{excellent:["ISFJ","ISTJ"],good:["ESFJ","ESTP","ISFP","ESFP"],neutral:["ENFP","ENFJ","ESTJ"],challenging:["INFJ","INFP","INTJ","INTP","ENTP","ENTJ","ISTP"]}
    };

    let raw = [];    // 원본
    let people = []; // 정제
    let me = null;   // {name, type, isMe:true}
    let layoutMode = "circle";

    const el = s => document.querySelector(s);
    const sleep = ms => new Promise(r=>setTimeout(r, ms));
    const withTimeout = (p, ms=9000) => Promise.race([p,new Promise((_,rej)=>setTimeout(()=>rej(new Error("요청 시간초과")),ms))]);

    function normalizeName(n){return (n??"").toString().replace(/\s+/g," ").trim();}
    function normalizeType(t){t=(t??"").toString().toUpperCase().trim();return /^[IE][NS][TF][JP]$/.test(t)?t:"";}
    function dedupe(list){
      const seen=new Set(), out=[];
      for(const r of list){
        const key=`${normalizeName(r.name)}|${normalizeType(r.type)}`;
        if(!seen.has(key) && normalizeType(r.type)){seen.add(key); out.push({name:normalizeName(r.name), type:normalizeType(r.type)});}
      }
      return out;
    }

    // ===== SVG 크기 동기화 =====
    const wires = el("#wires");
    const stage = el("#stage");
    function sizeSVG(){
      const rect = stage.getBoundingClientRect();
      wires.setAttribute("width", rect.width);
      wires.setAttribute("height", rect.height);
      wires.setAttribute("viewBox", `0 0 ${rect.width} ${rect.height}`);
    }

    // ===== 데이터 로드 =====
    async function loadData(){
      const btn = el("#btn-load");
      btn.disabled=true; btn.textContent="로딩 중…";
      try{
        const url = SHEET_URL + (SHEET_URL.includes("?")?"&":"?") + "_="+Date.now();
        const res = await withTimeout(fetch(url,{cache:"no-store"}));
        if(!res.ok) throw new Error("스프레드시트 응답 오류");
        const json = await res.json();
        if(!Array.isArray(json)) throw new Error("형식 오류: 배열이 아님");

        raw = json.map(r=>({name:normalizeName(r.name??r.이름), type:normalizeType(r.type??r.MBTI)}));
        people = dedupe(raw).slice(0, MAX_NODES);

        render(); updateStats();
        btn.textContent="✅ 로드 완료"; await sleep(800); btn.textContent="👥 관계도 불러오기";
      }catch(e){
        alert("데이터 불러오기 실패: " + e.message + "\n웹앱 공개/권한을 확인해주세요.");
        btn.textContent="다시 시도";
      }finally{btn.disabled=false;}
    }

    // ===== 렌더링 =====
    function render(){
      sizeSVG();
      stage.innerHTML = "";
      wires.innerHTML = "";

      const all = me ? [me, ...people] : people;
      if(all.length===0){
        stage.innerHTML = `<div style="position:absolute;inset:0;display:grid;place-items:center;color:#94a3b8">표시할 데이터가 없습니다</div>`;
        setStats("-", "-", 0); return;
      }

      const rect = stage.getBoundingClientRect();
      const cx = rect.width/2, cy = rect.height/2;

      const nodes=[];
      if(layoutMode==="circle"){
        const R = Math.min(cx, cy) * (all.length>10?0.68:0.58);
        all.forEach((p,i)=>{
          const ang=(i/all.length)*Math.PI*2 - Math.PI/2;
          nodes.push({p, x:cx+R*Math.cos(ang), y:cy+R*Math.sin(ang)});
        });
      }else{
        const cols=Math.ceil(Math.sqrt(all.length));
        const rows=Math.ceil(all.length/cols);
        const pad=16, cellW=(rect.width-pad*2)/cols, cellH=(rect.height-pad*2)/rows;
        all.forEach((p,i)=>{
          const r=Math.floor(i/cols), c=i%cols;
          nodes.push({p, x:pad+c*cellW+cellW/2, y:pad+r*cellH+cellH/2});
        });
      }

      // 선: 내 기준이면 나 ↔ 모두, 아니면 전체 희미하게
      if(me){
        const meNode = nodes.find(n=>n.p.isMe);
        nodes.forEach(n=>{
          if(n===meNode) return;
          wires.appendChild(makeLine(meNode, n, true));
        });
      }else{
        for(let i=0;i<nodes.length;i++){
          for(let j=i+1;j<nodes.length;j++){
            const L = makeLine(nodes[i], nodes[j], false);
            L.setAttribute("stroke-opacity", .15);
            wires.appendChild(L);
          }
        }
      }

      // 노드 배치
      nodes.forEach(n=>{
        const node = makeNode(n.p);
        const size = n.p.isMe?30:24;
        node.style.left = (n.x - size) + "px";
        node.style.top  = (n.y - size) + "px";
        stage.appendChild(node);
      });
    }

    function makeLine(a,b,strong){
      const level = getLevel(a.p.type, b.p.type);
      const color = ({excellent:"#22c55e",good:"#3b82f6",neutral:"#f59e0b",challenging:"#ef4444"})[level] || "#94a3b8";
      const line = document.createElementNS("http://www.w3.org/2000/svg","line");
      line.setAttribute("x1", a.x); line.setAttribute("y1", a.y);
      line.setAttribute("x2", b.x); line.setAttribute("y2", b.y);
      line.setAttribute("stroke", color);
      line.setAttribute("stroke-width", strong?3:2);
      line.setAttribute("data-t1", a.p.type); line.setAttribute("data-t2", b.p.type);
      return line;
    }

    function makeNode(p){
      const wrap=document.createElement("div");
      wrap.style.position="absolute"; wrap.style.display="flex"; wrap.style.flexDirection="column"; wrap.style.alignItems="center"; wrap.style.cursor="pointer";

      const circle=document.createElement("div");
      circle.style.width=p.isMe?"60px":"50px";
      circle.style.height=p.isMe?"60px":"50px";
      circle.style.borderRadius="50%";
      circle.style.display="grid"; circle.style.placeItems="center";
      circle.style.fontSize=p.isMe?"26px":"22px";
      circle.style.background=`linear-gradient(135deg, ${mbtiColor[p.type]||"#ddd"}, ${(mbtiColor[p.type]||"#ddd")}dd)`;
      circle.style.border=p.isMe?"3px solid gold":"2px solid #fff";
      circle.style.boxShadow=p.isMe?"0 0 15px rgba(255,215,0,.5)":"0 4px 12px rgba(0,0,0,.12)";
      if(p.isMe) circle.style.animation="pulse 2s infinite";
      circle.textContent=mbtiEmojis[p.type]||"❓";

      const label=document.createElement("div");
      label.textContent=p.type;
      label.style.marginTop="4px"; label.style.padding="2px 8px"; label.style.borderRadius="999px";
      label.style.background="#fff"; label.style.fontSize="12px"; label.style.fontWeight="800";
      label.style.color=mbtiColor[p.type]||"#334155"; label.style.boxShadow="0 2px 6px rgba(0,0,0,.08)";

      const name=document.createElement("div");
      name.textContent=p.name || (p.isMe?"나":"");
      name.style.marginTop="2px"; name.style.fontSize="11px"; name.style.color="#475569";
      name.style.maxWidth="84px"; name.style.whiteSpace="nowrap"; name.style.overflow="hidden"; name.style.textOverflow="ellipsis";

      wrap.appendChild(circle); wrap.appendChild(label); if(name.textContent) wrap.appendChild(name);
      wrap.addEventListener("click", ()=>{ highlight(p); openSheet(p); });
      return wrap;
    }

    function getLevel(t1,t2){
      const m = comp[t1]; if(!m) return "neutral";
      if(m.excellent.includes(t2)) return "excellent";
      if(m.good.includes(t2)) return "good";
      if(m.challenging.includes(t2)) return "challenging";
      return "neutral";
    }

    function highlight(target){
      // 나 기준 하이라이트
      [...wires.querySelectorAll("line")].forEach(L=>{
        const t1=L.getAttribute("data-t1"), t2=L.getAttribute("data-t2");
        const on = me
          ? (target.isMe ? (t1===me.type || t2===me.type)
                         : ((t1===me.type && t2===target.type) || (t2===me.type
