<!DOCTYPE html>
<html lang="ko">
  <head>
    <meta charset="UTF-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"
    />
    <title>MBTI ê´€ê³„ë„</title>

    <style>
      :root {
        /* ğŸ”¹ í¬ì¸íŠ¸ ì»¬ëŸ¬ (ì´ë¯¸ì§€ ìƒ‰ ê³„ì—´) */
        --brand:#00d1c4;
        --brand-dark:#00b3a8;

        --bg:#0f172a;
        --panel:#ffffff;
        --line:#e5e7eb;
        --good:#16a34a;
        --normal:#f59e0b;
        --effort:#ef4444;
      }

      *{
        box-sizing:border-box;
        margin:0;padding:0;
        -webkit-tap-highlight-color:transparent;
      }
      body{
        font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,'Helvetica Neue',Arial,sans-serif;
        background:var(--bg);
        color:#0f172a;
        min-height:100vh;
        padding:8px;
      }

      .app{
        max-width:480px;
        margin:0 auto;
        background:var(--panel);
        border-radius:16px;
        overflow:hidden;
        display:flex;
        flex-direction:column;
        min-height:calc(100vh - 16px);
        box-shadow:0 14px 40px rgba(0,0,0,.35);
      }

      /* ğŸ”¥ ëŒì•„ê°€ê¸° ì•„ì´ì½˜ (Floating Button) */
      .btn-floating-back{
        position:fixed;
        top:14px;
        left:14px;
        width:42px;
        height:42px;
        border-radius:50%;
        background:rgba(15,23,42,0.9);
        backdrop-filter:blur(4px);
        color:#fff;
        font-size:22px;
        display:flex;
        align-items:center;
        justify-content:center;
        cursor:pointer;
        z-index:9999;
        border:1px solid rgba(255,255,255,.15);
        box-shadow:0 5px 14px rgba(0,0,0,.35);
      }
      .btn-floating-back:active{
        background:rgba(15,23,42,1);
      }

      .top{
        position:sticky;
        top:0;
        z-index:10;
        background:linear-gradient(135deg,var(--brand-dark),var(--brand));
        color:#fff;
        padding:12px 10px 10px;
      }
      .top-title{
        font-weight:800;
        font-size:16px;
        text-align:center;
        margin-bottom:8px;
      }

      .top-row{
        display:flex;
        gap:6px;
        margin-bottom:6px;
      }
      .top-row input,
      .top-row select{
        flex:1;
        border-radius:10px;
        border:0;
        padding:8px 9px;
        font-size:13px;
      }
      .top-row input::placeholder{
        color:#9ca3af;
      }

      .btn-main{
        width:100%;
        border:0;
        border-radius:10px;
        background:var(--brand);
        color:#fff;
        font-weight:700;
        padding:9px 0;
        font-size:14px;
        cursor:pointer;
      }
      .btn-main:active{
        background:var(--brand-dark);
      }

      .top-target{
        margin-top:6px;
        font-size:12px;
        text-align:center;
        opacity:.9;
      }

      .content{
        flex:1;
        overflow:auto;
        padding:10px;
        display:flex;
        flex-direction:column;
        gap:10px;
      }

      .section{
        border-radius:12px;
        padding:8px 9px;
      }
      .sec-title{
        font-weight:800;
        margin-bottom:4px;
        font-size:13px;
      }
      .sec-sub{
        font-size:11px;
        opacity:.7;
        margin-bottom:6px;
      }

      .sec-good{background:#ecfdf3;border:1px solid #bbf7d0;}
      .sec-normal{background:#fff7ed;border:1px solid #fed7aa;}
      .sec-effort{background:#fef2f2;border:1px solid #fecaca;}

      .mbti-row{
        display:flex;
        align-items:flex-start;
        gap:6px;
        margin-bottom:4px;
        flex-wrap:wrap;
      }
      .mbti-label{
        min-width:48px;
        padding:6px 6px;
        border-radius:999px;
        background:#e0fffb;
        text-align:center;
        font-size:11px;
        font-weight:800;
        color:var(--brand-dark);
      }
      .chip-wrap{
        display:flex;
        flex-wrap:wrap;
        gap:4px;
      }
      .chip{
        font-size:11px;
        padding:5px 8px;
        border-radius:999px;
        border:1px solid var(--line);
        background:#fff;
        cursor:pointer;
      }
      .chip span.count{
        font-size:10px;
        opacity:.7;
        margin-left:4px;
      }

      .empty{
        font-size:12px;
        text-align:center;
        padding:12px 4px;
        color:#9ca3af;
      }

      .bottom{
        position:sticky;
        bottom:0;
        background:#0f172a;
        color:#e5e7eb;
        padding:8px 10px;
        font-size:11px;
      }
      .bottom-title{
        font-weight:700;
        margin-bottom:4px;
      }
      .bottom-ul{
        list-style:none;
      }
      .bottom-ul li{
        margin-bottom:2px;
      }
    </style>
  </head>

  <body>

    <!-- ğŸ”¥ ëŒì•„ê°€ê¸° ë²„íŠ¼ (ê³ ì • ì•„ì´ì½˜) -->
    <div id="btnBack" class="btn-floating-back">â†</div>

    <div class="app">
      <!-- ìƒë‹¨ ê³ ì • -->
      <header class="top">
        <div class="top-title">ìš°ìˆ˜ì‚¬ë¡€ ì°¸ê°€ì MBTI ê´€ê³„ë„</div>

        <div class="top-row">
          <input id="nameInput" type="text" placeholder="ì´ë¦„ (ì˜ˆ: ê¹€í˜„ì² )" />
          <select id="mbtiInput">
            <option value="">MBTI ì„ íƒ</option>
            <option>INTJ</option><option>INTP</option><option>ENTJ</option><option>ENTP</option>
            <option>INFJ</option><option>INFP</option><option>ENFJ</option><option>ENFP</option>
            <option>ISTJ</option><option>ISFJ</option><option>ESTJ</option><option>ESFJ</option>
            <option>ISTP</option><option>ISFP</option><option>ESTP</option><option>ESFP</option>
          </select>
        </div>

        <button id="btnRun" class="btn-main">ê´€ê³„ë„ ë³´ê¸°</button>

        <div id="targetInfo" class="top-target">
          ì´ë¦„ê³¼ MBTIë¥¼ ì…ë ¥í•˜ê³  ê´€ê³„ë„ë¥¼ í™•ì¸í•´ ë³´ì„¸ìš”.
        </div>
      </header>

      <!-- ì¤‘ê°„ ìŠ¤í¬ë¡¤ -->
      <main class="content" id="content">
        <div class="empty">
          ì•„ì§ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.<br />
          ìƒë‹¨ì—ì„œ ì´ë¦„ / MBTIë¥¼ ì…ë ¥í•œ ë’¤ â€˜ê´€ê³„ë„ ë³´ê¸°â€™ë¥¼ ëˆŒëŸ¬ ì£¼ì„¸ìš”.
        </div>
      </main>

      <!-- í•˜ë‹¨ ê³ ì • -->
      <footer class="bottom">
        <div class="bottom-title">ê´€ê³„ë„ ì •ì˜</div>
        <ul class="bottom-ul">
          <li>â€¢ <span style="color:#4ade80;">ì¢‹ìŒ</span> : í˜‘ì—… ì‹œ ì‹œë„ˆì§€ ë†’ìŒ</li>
          <li>â€¢ <span style="color:#fb923c;">ë³´í†µ</span> : ì¡°ìœ¨ì— ë”°ë¼ í˜‘ì—… ê°€ëŠ¥</li>
          <li>â€¢ <span style="color:#fca5a5;">ë…¸ë ¥ í•„ìš”</span> : ì†Œí†µÂ·ë°°ë ¤ í•„ìš”</li>
        </ul>
      </footer>
    </div>

    <!-- âœ… ìŠ¤í¬ë¦½íŠ¸ëŠ” body ë§¨ ë§ˆì§€ë§‰ì—! -->
    <script>
      console.log("MBTI í˜ì´ì§€ ìŠ¤í¬ë¦½íŠ¸ ì‹œì‘");

      // âœ… Apps Script ì›¹ì•± URL (exec ì£¼ì†Œ)
      const API_URL = "https://script.google.com/macros/s/AKfycbw0vXlKjlj-vu-Epq8PqrG331dxWOLIfPPu71f16pE8vRwNEmbkZE35Ka7LM85kvjEi/exec";

      // DOM ìš”ì†Œ ì°¸ì¡°
      const btnBack = document.getElementById("btnBack");
      const btnRun = document.getElementById('btnRun');
      const nameInput = document.getElementById('nameInput');
      const mbtiInput = document.getElementById('mbtiInput');
      const targetInfo = document.getElementById('targetInfo');
      const content = document.getElementById('content');

      // ğŸ”™ ëŒì•„ê°€ê¸° ì•„ì´ì½˜ â†’ ë§í¬ ì´ë™
      btnBack.addEventListener("click", () => {
        window.location.href = "https://kim950106.github.io/travel-recommendation/";
      });

      // JS ìª½ì—ì„œë„ MBTI ê¶í•© ê³„ì‚° í•¨ìˆ˜ í•˜ë‚˜ ê°€ì§€ê³  ìˆê²Œ
      function jsRelationLevel(target, other){
        if(!target || !other) return "normal";
        const a = String(target).toUpperCase();
        const b = String(other).toUpperCase();
        if(a.length !== 4 || b.length !== 4) return "normal";
        if(a === b) return "good";
        let score = 0;
        if(a[1] === b[1]) score++;
        if(a[2] === b[2]) score++;
        if(a[3] === b[3]) score++;
        if(score >= 2) return "good";
        if(score === 1) return "normal";
        return "effort";
      }

      // ğŸ”§ ì–´ë–¤ í˜•íƒœì˜ JSONì´ ì™€ë„ {targetName, targetMbti, groups} ë¡œ ë§ì¶°ì£¼ëŠ” ì •ê·œí™”
      function normalizeData(raw, fallbackName, fallbackMbti){
        console.log("ì›ë³¸ ì‘ë‹µ ë°ì´í„°:", raw);

        // 1) ê¸°ë³¸ ê°’
        let targetName = raw.targetName || fallbackName || "";
        let targetMbti = (raw.targetMbti || fallbackMbti || "").toUpperCase();
        let groups = raw.groups;

        // 2) groups ì—†ê³ , members ë°°ì—´ë§Œ ì˜¨ ê²½ìš° â†’ ì—¬ê¸°ì„œ ì§ì ‘ ê·¸ë£¹ ê³„ì‚°
        if(!groups && Array.isArray(raw.members)){
          const members = raw.members
            .map((m,idx) => ({
              id: m.id ?? (idx+1),
              name: m.name || m.ì´ë¦„ || "",
              // ë°±ì—”ë“œê°€ {name, type} êµ¬ì¡°ì´ë¯€ë¡œ typeë„ MBTI í›„ë³´ì— í¬í•¨
              mbti: (m.mbti || m.MBTI || m.type || "").toUpperCase()
            }))
            .filter(m => m.name && m.mbti);

          if(!targetMbti && targetName){
            const found = members.find(m => m.name === targetName);
            if(found) targetMbti = found.mbti;
          }
          if(!targetMbti && members.length > 0){
            targetMbti = members[0].mbti;
          }

          const map = {good:{}, normal:{}, effort:{}};

          members.forEach(m => {
            const level = jsRelationLevel(targetMbti, m.mbti);
            const bucket = map[level];
            if(!bucket[m.mbti]) bucket[m.mbti] = [];
            bucket[m.mbti].push(m.name);
          });

          const toArr = obj => Object.keys(obj).sort().map(mbti => ({
            mbti,
            names: obj[mbti]
          }));

          groups = {
            good: toArr(map.good),
            normal: toArr(map.normal),
            effort: toArr(map.effort)
          };
        }

        if(!groups){
          groups = {good:[], normal:[], effort:[]};
        }

        return {
          targetName,
          targetMbti,
          groups
        };
      }

      function renderRelations(rawData){
        const data = normalizeData(
          rawData,
          nameInput.value.trim(),
          mbtiInput.value.trim()
        );

        if (rawData.error && !data.targetMbti){
          targetInfo.textContent = rawData.error;
          content.innerHTML = '<div class="empty">'+ rawData.error +'</div>';
          return;
        }

        if(!data.targetMbti){
          targetInfo.textContent = 'MBTIë¥¼ ì•Œ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ì´ë¦„ ë˜ëŠ” MBTIë¥¼ í™•ì¸í•´ ì£¼ì„¸ìš”.';
          content.innerHTML = '<div class="empty">MBTI ì •ë³´ê°€ ì—†ì–´ ê´€ê³„ë„ë¥¼ ë§Œë“¤ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</div>';
          return;
        }

        targetInfo.textContent =
          (data.targetName ? data.targetName + ' / ' : '') +
          'MBTI: ' + data.targetMbti + ' ê¸°ì¤€ ê´€ê³„ë„';

        const groups = data.groups || {good:[], normal:[], effort:[]};

        function renderSection(title, sub, cssClass, items){
          if (!items || items.length === 0){
            return `
              <section class="section ${cssClass}">
                <div class="sec-title">${title}</div>
                <div class="sec-sub">${sub}</div>
                <div class="empty">í•´ë‹¹ë˜ëŠ” MBTIê°€ ì—†ìŠµë‹ˆë‹¤.</div>
              </section>
            `;
          }

          const rows = items.map(item => {
            const names = item.names || [];
            const chipLabel = item.mbti;
            const count = names.length;
            const namesStr = names.join(', ');
            const dataNames = encodeURIComponent(namesStr);

            return `
              <div class="mbti-row">
                <div class="mbti-label">${chipLabel}</div>
                <div class="chip-wrap">
                  <button class="chip"
                          data-names="${dataNames}">
                    ${chipLabel}
                    <span class="count">${count}ëª…</span>
                  </button>
                </div>
              </div>
            `;
          }).join('');

          return `
            <section class="section ${cssClass}">
              <div class="sec-title">${title}</div>
              <div class="sec-sub">${sub}</div>
              ${rows}
            </section>
          `;
        }

        const html = [
          renderSection('ì¢‹ìŒ', 'ì‹œë„ˆì§€ê°€ ë†’ì€ ìœ í˜•', 'sec-good', groups.good),
          renderSection('ë³´í†µ', 'ìƒí™©ì— ë”°ë¼ ë‹¤ë¥¸ ìœ í˜•', 'sec-normal', groups.normal),
          renderSection('ë…¸ë ¥ í•„ìš”', 'ì˜ì‚¬ì†Œí†µ ì£¼ì˜ í•„ìš”í•œ ìœ í˜•', 'sec-effort', groups.effort),
        ].join('');

        content.innerHTML = html;

        // MBTI ì¹© í´ë¦­ â†’ ì´ë¦„ íŒì—…
        content.querySelectorAll('.chip').forEach(chip => {
          chip.addEventListener('click', () => {
            const namesStr = decodeURIComponent(chip.dataset.names || '');
            if (!namesStr){
              alert('í•´ë‹¹ MBTI ì¸ì›ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
              return;
            }
            alert('í•´ë‹¹ MBTI ì¸ì›:\n\n' + namesStr);
          });
        });
      }

      // ğŸ”¥ ë²„íŠ¼ í´ë¦­ ì‹œ Apps Script API í˜¸ì¶œ
      btnRun.addEventListener('click', async () => {
        const name = nameInput.value.trim();
        const mbti = mbtiInput.value.trim();

        targetInfo.textContent = 'ê´€ê³„ë„ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ì…ë‹ˆë‹¤...';

        try{
          const url = API_URL
            + '?name=' + encodeURIComponent(name)
            + '&mbti=' + encodeURIComponent(mbti);

          console.log("ìš”ì²­ URL:", url);

          const res = await fetch(url);
          console.log("HTTP ìƒíƒœ:", res.status);

          if(!res.ok){
            throw new Error('HTTP ' + res.status);
          }

          const raw = await res.json();
          console.log('API ì‘ë‹µ(raw):', raw);

          // ë°±ì—”ë“œê°€ ë°°ì—´([ {name,type}, ... ])ì„ ë³´ë‚´ë©´ membersë¡œ ë˜í•‘
          const dataForRender = Array.isArray(raw)
            ? { members: raw }
            : raw;

          renderRelations(dataForRender);
        }catch(err){
          console.error("fetch ì—ëŸ¬:", err);
          targetInfo.textContent = 'ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.';
          content.innerHTML = '<div class="empty">ì„œë²„ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.</div>';
        }
      });
    </script>
  </body>
</html>
