<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>MBTI 관계도</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            overflow-x: hidden;
            position: relative;
        }
        
        .mobile-container {
            width: 100%;
            min-height: 100vh;
            background: white;
            display: flex;
            flex-direction: column;
        }
        
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 15px;
            text-align: center;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            position: sticky;
            top: 0;
            z-index: 100;
        }
        
        .header h1 {
            font-size: 20px;
            font-weight: 600;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }
        
        .control-panel {
            background: #f8f9fa;
            padding: 15px;
            border-bottom: 1px solid #e0e0e0;
        }
        
        .input-row {
            display: flex;
            gap: 10px;
            margin-bottom: 10px;
        }
        
        .input-row input {
            flex: 1;
            padding: 10px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 14px;
        }
        
        .input-row select {
            flex: 1;
            padding: 10px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 14px;
            background: white;
        }
        
        .btn-primary {
            width: 100%;
            padding: 12px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            margin-bottom: 10px;
            cursor: pointer;
        }
        
        .btn-secondary {
            width: 100%;
            padding: 10px;
            background: white;
            color: #667eea;
            border: 2px solid #667eea;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
        }
        
        .data-input-toggle {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 10px;
            background: #e8f0ff;
            border-radius: 8px;
            margin-bottom: 10px;
            cursor: pointer;
            background: #e8f5e9;
            border: 2px solid #4caf50;
        }
        
        .data-input-content {
            display: none;
            margin-top: 10px;
        }
        
        .data-input-content.show {
            display: block;
        }
        
        .help-text {
            font-size: 11px;
            color: #888;
            margin-top: 5px;
            line-height: 1.4;
        }
        
        .visualization-area {
            flex: 1;
            position: relative;
            min-height: 400px;
            background: linear-gradient(135deg, #ffeef8 0%, #e6f2ff 100%);
            overflow: hidden;
        }
        
        #canvas-container {
            position: relative;
            width: 100%;
            height: 100%;
            min-height: 400px;
        }
        
        .mbti-node {
            position: absolute;
            display: flex;
            flex-direction: column;
            align-items: center;
            touch-action: none;
            cursor: pointer;
            transition: transform 0.2s;
            z-index: 10;
        }
        
        .mbti-node.active {
            transform: scale(1.15);
            z-index: 50;
        }
        
        .node-circle {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 22px;
            background: white;
            box-shadow: 0 3px 10px rgba(0,0,0,0.15);
            border: 2px solid white;
        }
        
        .node-circle.me {
            width: 60px;
            height: 60px;
            font-size: 26px;
            border: 3px solid gold;
            box-shadow: 0 0 15px rgba(255, 215, 0, 0.5);
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }
        
        .node-label {
            margin-top: 3px;
            padding: 2px 6px;
            background: white;
            border-radius: 10px;
            font-size: 10px;
            font-weight: bold;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        
        .node-name {
            margin-top: 2px;
            padding: 1px 5px;
            background: rgba(255, 255, 255, 0.9);
            border-radius: 6px;
            font-size: 9px;
            color: #666;
            max-width: 60px;
            text-overflow: ellipsis;
            overflow: hidden;
            white-space: nowrap;
        }
        
        .connection-line {
            position: absolute;
            height: 2px;
            transform-origin: left center;
            z-index: 1;
            opacity: 0.5;
        }
        
        .connection-line.highlight {
            opacity: 1;
            height: 3px;
            z-index: 5;
        }
        
        .connection-excellent {
            background: #4caf50;
        }
        
        .connection-good {
            background: #2196f3;
        }
        
        .connection-neutral {
            background: #ffc107;
        }
        
        .connection-challenging {
            background: #ff5722;
        }
        
        .legend {
            display: flex;
            justify-content: space-around;
            padding: 10px;
            background: white;
            border-top: 1px solid #e0e0e0;
            flex-wrap: wrap;
            gap: 10px;
        }
        
        .legend-item {
            display: flex;
            align-items: center;
            gap: 4px;
            font-size: 11px;
            color: #555;
        }
        
        .legend-line {
            width: 20px;
            height: 3px;
            border-radius: 2px;
        }
        
        .stats-panel {
            background: white;
            padding: 15px;
            border-top: 2px solid #f0f0f0;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            margin-bottom: 10px;
        }
        
        .stat-card {
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            padding: 10px;
            border-radius: 8px;
            text-align: center;
        }
        
        .stat-value {
            font-size: 18px;
            font-weight: bold;
            color: #333;
        }
        
        .stat-label {
            font-size: 10px;
            color: #666;
            margin-top: 2px;
        }
        
        .relationship-details {
            background: #f8f9fa;
            padding: 10px;
            border-radius: 8px;
            font-size: 12px;
            line-height: 1.6;
        }
        
        .relationship-item {
            margin: 5px 0;
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        .info-popup {
            position: fixed;
            bottom: -100%;
            left: 0;
            right: 0;
            background: white;
            border-top-left-radius: 20px;
            border-top-right-radius: 20px;
            box-shadow: 0 -5px 20px rgba(0,0,0,0.2);
            padding: 20px;
            z-index: 200;
            transition: bottom 0.3s;
        }
        
        .info-popup.show {
            bottom: 0;
        }
        
        .popup-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }
        
        .popup-title {
            font-size: 18px;
            font-weight: bold;
            color: #333;
        }
        
        .popup-close {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            background: #f0f0f0;
            border: none;
            font-size: 18px;
            color: #666;
            cursor: pointer;
        }
        
        .popup-content {
            font-size: 14px;
            line-height: 1.6;
        }
        
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-left: 10px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        @media (max-width: 375px) {
            .node-circle {
                width: 45px;
                height: 45px;
                font-size: 20px;
            }
            
            .node-circle.me {
                width: 55px;
                height: 55px;
                font-size: 24px;
            }
            
            .node-label {
                font-size: 9px;
            }
            
            .node-name {
                font-size: 8px;
            }
        }
        
        @media (min-width: 768px) {
            .mobile-container {
                max-width: 768px;
                margin: 0 auto;
                box-shadow: 0 0 30px rgba(0,0,0,0.1);
            }
            
            .stats-grid {
                grid-template-columns: repeat(4, 1fr);
            }
        }
    </style>
</head>
<body>
    <div class="mobile-container">
        <div class="header">
            <h1>🌟 MBTI 관계도 🌟</h1>
        </div>
        
        <div class="control-panel">
            <div class="input-row">
                <input type="text" id="myName" placeholder="내 이름">
                <select id="myMbti">
                    <option value="">내 MBTI 선택</option>
                    <option value="INTJ">INTJ</option>
                    <option value="INTP">INTP</option>
                    <option value="ENTJ">ENTJ</option>
                    <option value="ENTP">ENTP</option>
                    <option value="INFJ">INFJ</option>
                    <option value="INFP">INFP</option>
                    <option value="ENFJ">ENFJ</option>
                    <option value="ENFP">ENFP</option>
                    <option value="ISTJ">ISTJ</option>
                    <option value="ISFJ">ISFJ</option>
                    <option value="ESTJ">ESTJ</option>
                    <option value="ESFJ">ESFJ</option>
                    <option value="ISTP">ISTP</option>
                    <option value="ISFP">ISFP</option>
                    <option value="ESTP">ESTP</option>
                    <option value="ESFP">ESFP</option>
                </select>
            </div>
            <button class="btn-primary" onclick="addMyMbti()">📍 내 위치 추가</button>
            
            <button class="btn-primary" onclick="loadFromSheet()" style="background: linear-gradient(135deg, #4caf50, #66bb6a);">
                🔄 스프레드시트에서 데이터 가져오기
            </button>
            <div class="help-text" style="text-align: center; margin-top: 5px;">
                💡 버튼을 눌러 최신 데이터를 불러오세요
            </div>
        </div>
        
        <div class="visualization-area">
            <div id="canvas-container"></div>
        </div>
        
        <div class="legend">
            <div class="legend-item">
                <div class="legend-line connection-excellent"></div>
                <span>최고</span>
            </div>
            <div class="legend-item">
                <div class="legend-line connection-good"></div>
                <span>좋음</span>
            </div>
            <div class="legend-item">
                <div class="legend-line connection-neutral"></div>
                <span>보통</span>
            </div>
            <div class="legend-item">
                <div class="legend-line connection-challenging"></div>
                <span>도전적</span>
            </div>
        </div>
        
        <div class="stats-panel">
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-value" id="totalCount">0</div>
                    <div class="stat-label">총 인원</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="excellentCount">0</div>
                    <div class="stat-label">최고 궁합</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="challengingCount">0</div>
                    <div class="stat-label">도전적</div>
                </div>
            </div>
            
            <div class="relationship-details" id="relationshipDetails" style="display: none;">
                <div class="relationship-item" id="excellentList"></div>
                <div class="relationship-item" id="challengingList"></div>
            </div>
        </div>
        
        <div class="info-popup" id="infoPopup">
            <div class="popup-header">
                <div class="popup-title" id="popupTitle"></div>
                <button class="popup-close" onclick="closePopup()">✕</button>
            </div>
            <div class="popup-content" id="popupContent"></div>
        </div>
    </div>
    
    <script>
        // ⚠️ 여기에 Web App URL을 입력하세요!
        const SHEET_URL = 'https://script.google.com/macros/s/AKfycbxgPR8R0tD-eLfWV2tLcaI4SF9sCMh6tJhlYls4Yfzp84EbnoJEhJNShlmTHRqpTb-C/exec';
        
        const mbtiEmojis = {
            'INTJ': '🧙', 'INTP': '🤖', 'ENTJ': '👑', 'ENTP': '💡',
            'INFJ': '🦄', 'INFP': '🧚', 'ENFJ': '⭐', 'ENFP': '🦋',
            'ISTJ': '📚', 'ISFJ': '🧸', 'ESTJ': '💼', 'ESFJ': '🤗',
            'ISTP': '🔧', 'ISFP': '🎨', 'ESTP': '🏃', 'ESFP': '🎉'
        };
        
        const mbtiColors = {
            'INTJ': '#667eea', 'INTP': '#f093fb', 'ENTJ': '#4facfe', 'ENTP': '#43e97b',
            'INFJ': '#fa709a', 'INFP': '#30cfd0', 'ENFJ': '#a8edea', 'ENFP': '#ff9a9e',
            'ISTJ': '#fbc2eb', 'ISFJ': '#fddb92', 'ESTJ': '#f6d365', 'ESFJ': '#fccb90',
            'ISTP': '#a1c4fd', 'ISFP': '#d4fc79', 'ESTP': '#84fab0', 'ESFP': '#fc5c7d'
        };
        
        const compatibilityData = {
            'INTJ': { excellent: ['ENFP', 'ENTP'], good: ['INFJ', 'INFP', 'ENFJ'], neutral: ['INTJ', 'ENTJ', 'INTP', 'ESTP', 'ISTP', 'ISFP'], challenging: ['ISFJ', 'ESFJ', 'ISTJ', 'ESFP', 'ESTJ'] },
            'INTP': { excellent: ['ENTJ', 'ESTJ'], good: ['INTJ', 'ENTP', 'INFJ'], neutral: ['INTP', 'ENFP', 'INFP', 'ENFJ', 'ISTP', 'ISFP'], challenging: ['ISFJ', 'ESFJ', 'ISTJ', 'ESTP', 'ESFP'] },
            'ENTJ': { excellent: ['INTP', 'INTJ'], good: ['ENTP', 'ENFJ', 'ENTJ'], neutral: ['INFJ', 'INFP', 'ENFP', 'ESTJ', 'ISTP', 'ESTP'], challenging: ['ISFJ', 'ESFJ', 'ISTJ', 'ISFP', 'ESFP'] },
            'ENTP': { excellent: ['INFJ', 'INTJ'], good: ['ENFP', 'ENFJ', 'ENTJ', 'INTP'], neutral: ['ENTP', 'INFP', 'ESTP', 'ISTP'], challenging: ['ISFJ', 'ESFJ', 'ISTJ', 'ISFP', 'ESFP', 'ESTJ'] },
            'INFJ': { excellent: ['ENTP', 'ENFP'], good: ['INTJ', 'INFJ', 'INTP', 'ENFJ'], neutral: ['INFP', 'ENTJ', 'ISFJ', 'ISTJ'], challenging: ['ESTP', 'ESFP', 'ISTP', 'ESFJ', 'ISFP', 'ESTJ'] },
            'INFP': { excellent: ['ENFJ', 'ENTJ'], good: ['INFJ', 'INTJ', 'INTP', 'ENFP'], neutral: ['INFP', 'ENTP', 'ISFP', 'ISFJ'], challenging: ['ESTP', 'ESFP', 'ISTP', 'ESFJ', 'ISTJ', 'ESTJ'] },
            'ENFJ': { excellent: ['INFP', 'ISFP'], good: ['ENFP', 'INFJ', 'ENFJ', 'INTJ', 'ENTJ'], neutral: ['ENTP', 'INTP', 'ESFJ', 'ISFJ'], challenging: ['ESTP', 'ESFP', 'ISTP', 'ISTJ', 'ESTJ'] },
            'ENFP': { excellent: ['INTJ', 'INFJ'], good: ['ENTJ', 'ENTP', 'ENFJ', 'INFP'], neutral: ['ENFP', 'INTP', 'ESFP', 'ISFP'], challenging: ['ISTP', 'ESTP', 'ISFJ', 'ISTJ', 'ESFJ', 'ESTJ'] },
            'ISTJ': { excellent: ['ESFP', 'ESTP'], good: ['ISFJ', 'ISTJ', 'ESTJ', 'ESFJ'], neutral: ['INTJ', 'INTP', 'INFJ', 'ISTP'], challenging: ['INFP', 'ENFP', 'ENFJ', 'ENTP', 'ENTJ', 'ISFP'] },
            'ISFJ': { excellent: ['ESFP', 'ESTP'], good: ['ISFJ', 'ESFJ', 'ISTJ', 'ESTJ'], neutral: ['INFJ', 'INFP', 'ENFJ', 'ISFP'], challenging: ['INTJ', 'INTP', 'ENTP', 'ENTJ', 'ENFP', 'ISTP'] },
            'ESTJ': { excellent: ['ISFP', 'ISTP'], good: ['ISTJ', 'ESFJ', 'ISFJ', 'ESTJ'], neutral: ['ENTJ', 'INTP', 'ESTP', 'ESFP'], challenging: ['INFJ', 'INFP', 'ENFJ', 'ENFP', 'INTJ', 'ENTP'] },
            'ESFJ': { excellent: ['ISFP', 'ISTP'], good: ['ESFJ', 'ISFJ', 'ESTJ', 'ISTJ'], neutral: ['ENFJ', 'ISFP', 'ESFP', 'ESTP'], challenging: ['INFJ', 'INFP', 'ENFP', 'INTJ', 'INTP', 'ENTP', 'ENTJ'] },
            'ISTP': { excellent: ['ESFJ', 'ESTJ'], good: ['INTJ', 'INTP', 'ESTP', 'ISTP'], neutral: ['ENTJ', 'ENTP', 'ISFJ', 'ISTJ', 'ISFP'], challenging: ['INFJ', 'INFP', 'ENFP', 'ENFJ', 'ESFP'] },
            'ISFP': { excellent: ['ENFJ', 'ESFJ', 'ESTJ'], good: ['ISFJ', 'ESFP', 'ISFP'], neutral: ['INTJ', 'INTP', 'INFP', 'ENFP', 'ISTP', 'ISTJ'], challenging: ['INFJ', 'ENTJ', 'ENTP', 'ESTP'] },
            'ESTP': { excellent: ['ISFJ', 'ISTJ'], good: ['ESFP', 'ISTP', 'ESTP', 'ESFJ'], neutral: ['ENTJ', 'ENTP', 'INTJ', 'ESTJ'], challenging: ['INFJ', 'INFP', 'ENFJ', 'ENFP', 'INTP', 'ISFP'] },
            'ESFP': { excellent: ['ISFJ', 'ISTJ'], good: ['ESFJ', 'ESTP', 'ISFP', 'ESFP'], neutral: ['ENFP', 'ENFJ', 'ESTJ'], challenging: ['INFJ', 'INFP', 'INTJ', 'INTP', 'ENTP', 'ENTJ', 'ISTP'] }
        };
        
        let nodes = [];
        let connections = [];
        let myData = null;
        
        window.onload = function() {
            // 페이지 로드시 자동으로 데이터 불러오기
            loadFromSheet();
            
            const visualArea = document.querySelector('.visualization-area');
            const availableHeight = window.innerHeight - 
                document.querySelector('.header').offsetHeight - 
                document.querySelector('.control-panel').offsetHeight - 
                document.querySelector('.legend').offsetHeight - 
                document.querySelector('.stats-panel').offsetHeight;
            visualArea.style.height = Math.max(400, availableHeight) + 'px';
        };
        
        async function loadFromSheet() {
            if (SHEET_URL === 'YOUR_WEB_APP_URL_HERE') {
                alert('⚠️ 개발자에게 문의하세요!\nindex.html 파일에서 SHEET_URL을 설정해야 합니다.');
                return;
            }
            
            const button = event?.target;
            let originalText = '';
            
            if (button) {
                originalText = button.innerHTML;
                button.innerHTML = '로딩중...<span class="loading"></span>';
                button.disabled = true;
            }
            
            try {
                const response = await fetch(SHEET_URL);
                if (!response.ok) {
                    throw new Error('데이터를 가져올 수 없습니다');
                }
                
                const data = await response.json();
                
                if (!Array.isArray(data) || data.length === 0) {
                    alert('스프레드시트에 데이터가 없습니다');
                    return;
                }
                
                const limitedData = data.slice(0, 13);
                
                visualize(limitedData);
                updateStats(limitedData);
                
                if (button) {
                    button.innerHTML = '✅ 불러오기 완료!';
                    setTimeout(() => {
                        button.innerHTML = originalText;
                    }, 2000);
                }
                
            } catch (error) {
                console.error('Error:', error);
                alert('데이터 불러오기 실패\n' + error.message);
                if (button) button.innerHTML = originalText;
            } finally {
                if (button) button.disabled = false;
            }
        }
        
        function addMyMbti() {
            const myName = document.getElementById('myName').value.trim();
            const myMbti = document.getElementById('myMbti').value;
            
            if (!myMbti) {
                alert('MBTI를 선택해주세요!');
                return;
            }
            
            myData = {
                name: myName || '나',
                type: myMbti,
                isMe: true
            };
            
            loadFromSheet();
        }
        
        function visualize(data) {
            const container = document.getElementById('canvas-container');
            container.innerHTML = '';
            nodes = [];
            connections = [];
            
            if (myData) {
                data = [myData, ...data.filter(d => !d.isMe)].slice(0, 13);
            }
            
            const rect = container.getBoundingClientRect();
            const centerX = rect.width / 2;
            const centerY = rect.height / 2;
            
            const radiusRatio = Math.min(rect.width, rect.height) < 400 ? 0.35 : 0.4;
            const radius = Math.min(centerX, centerY) * radiusRatio;
            
            data.forEach((person, index) => {
                const angle = (index * 2 * Math.PI) / data.length - Math.PI / 2;
                const x = centerX + radius * Math.cos(angle);
                const y = centerY + radius * Math.sin(angle);
                
                const node = createNode(person, x, y);
                container.appendChild(node);
                nodes.push({ element: node, data: person, x, y });
            });
            
            drawConnections();
        }
        
        function createNode(person, x, y) {
            const node = document.createElement('div');
            node.className = 'mbti-node';
            
            const isMe = person.isMe;
            const nodeSize = isMe ? 30 : 25;
            
            node.style.left = (x - nodeSize) + 'px';
            node.style.top = (y - nodeSize) + 'px';
            
            const circle = document.createElement('div');
            circle.className = 'node-circle' + (isMe ? ' me' : '');
            circle.style.background = `linear-gradient(135deg, ${mbtiColors[person.type]}, ${mbtiColors[person.type]}dd)`;
            circle.innerHTML = mbtiEmojis[person.type] || '❓';
            
            const label = document.createElement('div');
            label.className = 'node-label';
            label.textContent = person.type;
            label.style.color = mbtiColors[person.type];
            
            node.appendChild(circle);
            node.appendChild(label);
            
            if (person.name) {
                const name = document.createElement('div');
                name.className = 'node-name';
                name.textContent = person.name;
                node.appendChild(name);
            }
            
            node.addEventListener('click', (e) => {
                e.stopPropagation();
                handleNodeClick(person);
            });
            
            return node;
        }
        
        function handleNodeClick(person) {
            nodes.forEach(n => n.element.classList.remove('active'));
            
            const clickedNode = nodes.find(n => n.data === person);
            if (clickedNode) {
                clickedNode.element.classList.add('active');
            }
            
            if (myData && !person.isMe) {
                highlightConnection(myData.type, person.type);
            } else if (person.isMe) {
                highlightAllMyConnections();
            }
            
            showPopup(person);
        }
        
        function drawConnections() {
            const container = document.getElementById('canvas-container');
            
            if (myData) {
                const myNode = nodes.find(n => n.data.isMe);
                if (!myNode) return;
                
                nodes.forEach(node => {
                    if (!node.data.isMe) {
                        const line = createConnection(myNode, node);
                        container.appendChild(line);
                        connections.push(line);
                    }
                });
            } else {
                for (let i = 0; i < nodes.length; i++) {
                    for (let j = i + 1; j < nodes.length; j++) {
                        const line = createConnection(nodes[i], nodes[j]);
                        line.style.opacity = '0.1';
                        container.appendChild(line);
                        connections.push(line);
                    }
                }
            }
        }
        
        function createConnection(node1, node2) {
            const line = document.createElement('div');
            const compatibility = getCompatibilityLevel(node1.data.type, node2.data.type);
            line.className = `connection-line connection-${compatibility}`;
            
            const dx = node2.x - node1.x;
            const dy = node2.y - node1.y;
            const distance = Math.sqrt(dx * dx + dy * dy);
            const angle = Math.atan2(dy, dx) * 180 / Math.PI;
            
            line.style.width = distance + 'px';
            line.style.left = node1.x + 'px';
            line.style.top = node1.y + 'px';
            line.style.transform = `rotate(${angle}deg)`;
            line.dataset.type1 = node1.data.type;
            line.dataset.type2 = node2.data.type;
            
            return line;
        }
        
        function getCompatibilityLevel(type1, type2) {
            if (!compatibilityData[type1]) return 'neutral';
            
            if (compatibilityData[type1].excellent.includes(type2)) return 'excellent';
            if (compatibilityData[type1].good.includes(type2)) return 'good';
            if (compatibilityData[type1].challenging.includes(type2)) return 'challenging';
            return 'neutral';
        }
        
        function highlightConnection(type1, type2) {
            connections.forEach(line => {
                if ((line.dataset.type1 === type1 && line.dataset.type2 === type2) ||
                    (line.dataset.type1 === type2 && line.dataset.type2 === type1)) {
                    line.classList.add('highlight');
                } else {
                    line.classList.remove('highlight');
                }
            });
        }
        
        function highlightAllMyConnections() {
            connections.forEach(line => {
                line.classList.add('highlight');
            });
        }
        
        function showPopup(person) {
            const popup = document.getElementById('infoPopup');
            const title = document.getElementById('popupTitle');
            const content = document.getElementById('popupContent');
            
            title.innerHTML = `${mbtiEmojis[person.type]} ${person.name || person.type}`;
            
            if (myData && !person.isMe) {
                const compatibility = getCompatibilityLevel(myData.type, person.type);
                const compatText = {
                    'excellent': '💚 최고의 궁합입니다!',
                    'good': '💙 좋은 궁합입니다',
                    'neutral': '💛 보통 관계입니다',
                    'challenging': '🧡 도전적 관계입니다'
                };
                
                content.innerHTML = `
                    <div style="margin-bottom: 10px;">
                        <strong>${myData.type} ↔ ${person.type}</strong>
                    </div>
                    <div style="font-size: 16px; margin-bottom: 15px;">
                        ${compatText[compatibility]}
                    </div>
                    <div style="font-size: 12px; line-height: 1.6;">
                        💡 <strong>관계 팁:</strong><br>
                        ${getRelationshipTip(myData.type, person.type, compatibility)}
                    </div>
                `;
            } else {
                const compatibility = compatibilityData[person.type];
                content.innerHTML = `
                    <div style="font-size: 14px; line-height: 1.8;">
                        <div>💚 최고 궁합: ${compatibility.excellent.join(', ')}</div>
                        <div>💙 좋은 궁합: ${compatibility.good.join(', ')}</div>
                        <div>💛 보통: ${compatibility.neutral.join(', ')}</div>
                        <div>🧡 도전적: ${compatibility.challenging.join(', ')}</div>
                    </div>
                `;
            }
            
            popup.classList.add('show');
        }
        
        function closePopup() {
            document.getElementById('infoPopup').classList.remove('show');
            nodes.forEach(n => n.element.classList.remove('active'));
            connections.forEach(line => line.classList.remove('highlight'));
        }
        
        function getRelationshipTip(type1, type2, level) {
            const tips = {
                'excellent': '서로를 보완하는 최고의 파트너입니다. 자연스러운 이해와 시너지를 만들어냅니다.',
                'good': '서로를 잘 이해하고 협력할 수 있습니다. 좋은 팀워크를 발휘할 수 있습니다.',
                'neutral': '서로를 이해하려는 노력이 필요합니다. 차이를 인정하고 존중하세요.',
                'challenging': '다른 관점을 가지고 있습니다. 인내심을 갖고 소통하면 성장할 수 있습니다.'
            };
            return tips[level];
        }
        
        function updateStats(data) {
            const total = data.filter(d => !d.isMe).length;
            document.getElementById('totalCount').textContent = total;
            
            if (myData) {
                const excellent = data.filter(p => !p.isMe && 
                    compatibilityData[myData.type].excellent.includes(p.type));
                const challenging = data.filter(p => !p.isMe && 
                    compatibilityData[myData.type].challenging.includes(p.type));
                
                document.getElementById('excellentCount').textContent = excellent.length;
                document.getElementById('challengingCount').textContent = challenging.length;
                
                const details = document.getElementById('relationshipDetails');
                if (excellent.length > 0 || challenging.length > 0) {
                    details.style.display = 'block';
                    
                    if (excellent.length > 0) {
                        document.getElementById('excellentList').innerHTML = 
                            `💚 최고: ${excellent.map(p => p.name || p.type).join(', ')}`;
                    }
                    
                    if (challenging.length > 0) {
                        document.getElementById('challengingList').innerHTML = 
                            `🧡 도전적: ${challenging.map(p => p.name || p.type).join(', ')}`;
                    }
                }
            } else {
                document.getElementById('excellentCount').textContent = '-';
                document.getElementById('challengingCount').textContent = '-';
                document.getElementById('relationshipDetails').style.display = 'none';
            }
        }
        
        document.addEventListener('click', function(e) {
            if (!e.target.closest('.mbti-node') && !e.target.closest('.info-popup')) {
                closePopup();
            }
        });
    </script>
</body>
</html>
