<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta
    name="viewport"
    content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"
  />
  <title>MBTI 관계도 | LS TourPass</title>
  <style>
    :root{
      --brand-start:#5b7cfa; /* 기존 톤 유지하되 대비 향상 */
      --brand-end:#7a53c8;
      --ink:#0f172a;
      --ink-2:#334155;
      --muted:#64748b;
      --bg:#ffffff;
      --panel:#f8fafc;
      --line:#e2e8f0;
      --ok:#10b981;
      --warn:#f59e0b;
      --bad:#ef4444;
      --chip:#eef2ff;
    }
    *{box-sizing:border-box;margin:0;padding:0;-webkit-tap-highlight-color:transparent}
    html,body{height:100%}
    body{
      font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,'Helvetica Neue',Arial,sans-serif;
      background:linear-gradient(135deg,var(--brand-start),var(--brand-end));
      color:var(--ink);
      overflow:hidden;
    }
    .app{
      display:flex;flex-direction:column;height:100%;max-width:820px;margin:0 auto;background:var(--bg);
      box-shadow:0 10px 30px rgba(0,0,0,.12)
    }
    .header{
      background:linear-gradient(135deg,var(--brand-start),var(--brand-end));
      color:#fff;padding:12px 14px;display:flex;align-items:center;justify-content:space-between
    }
    .title{font-weight:700;font-size:16px;letter-spacing:.2px;display:flex;gap:8px;align-items:center}
    .controls{background:var(--panel);border-bottom:1px solid var(--line);padding:10px 12px}
    .row{display:flex;gap:8px;flex-wrap:wrap}
    .row+.row{margin-top:8px}
    .btn{
      appearance:none;border:0;border-radius:10px;padding:10px 12px;font-weight:700;cursor:pointer
    }
    .btn-primary{
      background:linear-gradient(135deg,#16a34a,#22c55e);color:#fff;flex:1;min-width:140px
    }
    .btn-outline{
      background:#fff;border:2px solid var(--brand-start);color:var(--brand-start);font-weight:700
    }
    .input,select{
      flex:1;min-width:120px;background:#fff;border:2px solid var(--line);border-radius:10px;padding:10px 12px;font-size:14px
    }
    .chip{
      background:var(--chip);padding:6px 10px;border-radius:999px;font-size:12px;color:#3730a3;font-weight:700
    }
    .viz-wrap{position:relative;flex:1;min-height:420px;overflow:hidden;background:linear-gradient(135deg,#fff6fb,#eef7ff)}
    #stage{position:absolute;inset:0}
    .legend{
      display:flex;gap:12px;flex-wrap:wrap;padding:8px 12px;border-top:1px solid var(--line);background:#fff
    }
    .legend-item{display:flex;align-items:center;gap:6px;font-size:12px;color:var(--ink-2)}
    .legend-dot{width:18px;height:4px;border-radius:4px;display:inline-block}
    .stats{display:grid;grid-template-columns:repeat(3,1fr);gap:8px;padding:10px 12px;background:#fff;border-top:1px solid var(--line)}
    .stat{background:linear-gradient(180deg,#f6f7fb,#eaeef7);border-radius:10px;padding:8px;text-align:center}
    .stat .v{font-weight:800}
    .stat .k{font-size:11px;color:var(--muted)}
    .sheetbox{display:grid;grid-template-columns:1.2fr 1fr;gap:8px}
    .mebox{background:#eef6ff;border:1px solid #c7dbff;border-radius:10px;padding:8px}
    .gridbox{background:#f0fff7;border:1px solid #c8f3dd;border-radius:10px;padding:8px}
    .label{font-size:12px;color:#1e40af;font-weight:800;margin-bottom:6px;display:flex;align-items:center;gap:6px}
    .helper{font-size:12px;color:var(--muted)}
    .bottomsheet{
      position:fixed;left:0;right:0;bottom:-100%;background:#fff;border-top-left-radius:16px;border-top-right-radius:16px;
      box-shadow:0 -10px 30px rgba(0,0,0,.18);padding:16px;transition:bottom .25s ease;z-index:50;max-width:820px;margin:0 auto
    }
    .bottomsheet.show{bottom:0}
    .sheet-head{display:flex;justify-content:space-between;align-items:center;margin-bottom:10px}
    .sheet-title{font-weight:800}
    .x{width:34px;height:34px;display:grid;place-items:center;border-radius:50%;border:1px solid var(--line);background:#fff;cursor:pointer}
    .searchrow{display:flex;gap:8px;margin-top:8px}
    .mode-tabs{display:flex;gap:6px;flex-wrap:wrap}
    .tab{padding:8px 10px;border-radius:999px;border:1px solid var(--line);background:#fff;font-size:12px;cursor:pointer}
    .tab.active{background:#1e40af;color:#fff;border-color:#1e40af}
    @media (max-width:480px){.sheetbox{grid-template-columns:1fr}}
  </style>
</head>
<body>
  <div class="app">
    <div class="header">
      <div class="title">🌟 MBTI 관계도</div>
      <div class="mode-tabs" role="tablist" aria-label="배치 모드">
        <button class="tab active" id="mode-circle">원형 배치</button>
        <button class="tab" id="mode-grid">격자 배치</button>
      </div>
    </div>

    <div class="controls">
      <div class="row">
        <button id="btn-load" class="btn btn-primary">👥 관계도 불러오기</button>
        <button id="btn-reset" class="btn btn-outline">초기화</button>
      </div>

      <div class="searchrow">
        <input id="q" class="input" placeholder="🔎 이름 또는 MBTI(예: ENFP) 검색" />
        <select id="filterMbti">
          <option value="">MBTI 필터</option>
          <option>INTJ</option><option>INTP</option><option>ENTJ</option><option>ENTP</option>
          <option>INFJ</option><option>INFP</option><option>ENFJ</option><option>ENFP</option>
          <option>ISTJ</option><option>ISFJ</option><option>ESTJ</option><option>ESFJ</option>
          <option>ISTP</option><option>ISFP</option><option>ESTP</option><option>ESFP</option>
        </select>
      </div>

      <div class="row sheetbox">
        <div class="mebox">
          <div class="label">📍 내 위치 추가</div>
          <div class="row">
            <input id="myName" class="input" placeholder="내 이름(선택)" />
            <select id="myMbti" class="input">
              <option value="">내 MBTI 선택</option>
              <option>INTJ</option><option>INTP</option><option>ENTJ</option><option>ENTP</option>
              <option>INFJ</option><option>INFP</option><option>ENFJ</option><option>ENFP</option>
              <option>ISTJ</option><option>ISFJ</option><option>ESTJ</option><option>ESFJ</option>
              <option>ISTP</option><option>ISFP</option><option>ESTP</option><option>ESFP</option>
            </select>
          </div>
          <div class="row">
            <button id="btn-me" class="btn btn-primary">⭐ 내 기준 관계도 보기</button>
          </div>
          <div class="helper">* 내 MBTI를 선택하면 나와 팀원 간 ‘최고/도전적’ 궁합 수치를 바로 확인합니다.</div>
        </div>

        <div class="gridbox">
          <div class="label">🧹 데이터 정제</div>
          <div class="row">
            <span class="chip" id="chip-dup">중복 자동 제거</span>
            <span class="chip" id="chip-trim">대소문자·공백 정리</span>
          </div>
          <div class="helper">* 같은 이름+MBTI가 여러 번 있으면 1개만 유지합니다.</div>
        </div>
      </div>
    </div>

    <div class="viz-wrap">
      <svg id="wires" xmlns="http://www.w3.org/2000/svg" style="position:absolute;inset:0"></svg>
      <div id="stage" aria-live="polite"></div>
    </div>

    <div class="legend">
      <div class="legend-item"><span class="legend-dot" style="background:#22c55e"></span>최고</div>
      <div class="legend-item"><span class="legend-dot" style="background:#3b82f6"></span>좋음</div>
      <div class="legend-item"><span class="legend-dot" style="background:#f59e0b"></span>보통</div>
      <div class="legend-item"><span class="legend-dot" style="background:#ef4444"></span>도전적</div>
    </div>

    <div class="stats">
      <div class="stat"><div class="v" id="totalCount">0</div><div class="k">총 인원</div></div>
      <div class="stat"><div class="v" id="excellentCount">-</div><div class="k">최고 궁합</div></div>
      <div class="stat"><div class="v" id="challengingCount">-</div><div class="k">도전적</div></div>
    </div>

    <div id="sheet" class="bottomsheet" role="dialog" aria-modal="true" aria-labelledby="sheetTitle">
      <div class="sheet-head">
        <div class="sheet-title" id="sheetTitle">상세</div>
        <button class="x" id="sheetClose" aria-label="닫기">✕</button>
      </div>
      <div id="sheetBody" style="font-size:14px;line-height:1.7"></div>
    </div>
  </div>

  <script>
    // ====== 환경설정 ======
    const SHEET_URL = "https://script.google.com/macros/s/AKfycbxgPR8R0tD-eLfWV2tLcaI4SF9sCMh6tJhlYls4Yfzp84EbnoJEhJNShlmTHRqpTb-C/exec";
    const MAX_NODES = 30; // 과도한 데이터 시 UI 보호

    const mbtiEmojis = {
      INTJ:"🧙", INTP:"🤖", ENTJ:"👑", ENTP:"💡",
      INFJ:"🦄", INFP:"🧚", ENFJ:"⭐", ENFP:"🦋",
      ISTJ:"📚", ISFJ:"🧸", ESTJ:"💼", ESFJ:"🤗",
      ISTP:"🔧", ISFP:"🎨", ESTP:"🏃", ESFP:"🎉"
    };
    const mbtiColor = {
      INTJ:"#667eea", INTP:"#f093fb", ENTJ:"#4facfe", ENTP:"#43e97b",
      INFJ:"#fa709a", INFP:"#30cfd0", ENFJ:"#a8edea", ENFP:"#ff9a9e",
      ISTJ:"#fbc2eb", ISFJ:"#fddb92", ESTJ:"#f6d365", ESFJ:"#fccb90",
      ISTP:"#a1c4fd", ISFP:"#d4fc79", ESTP:"#84fab0", ESFP:"#fc5c7d"
    };

    const comp = {
      INTJ:{excellent:["ENFP","ENTP"],good:["INFJ","INFP","ENFJ"],neutral:["INTJ","ENTJ","INTP","ESTP","ISTP","ISFP"],challenging:["ISFJ","ESFJ","ISTJ","ESFP","ESTJ"]},
      INTP:{excellent:["ENTJ","ESTJ"],good:["INTJ","ENTP","INFJ"],neutral:["INTP","ENFP","INFP","ENFJ","ISTP","ISFP"],challenging:["ISFJ","ESFJ","ISTJ","ESTP","ESFP"]},
      ENTJ:{excellent:["INTP","INTJ"],good:["ENTP","ENFJ","ENTJ"],neutral:["INFJ","INFP","ENFP","ESTJ","ISTP","ESTP"],challenging:["ISFJ","ESFJ","ISTJ","ISFP","ESFP"]},
      ENTP:{excellent:["INFJ","INTJ"],good:["ENFP","ENFJ","ENTJ","INTP"],neutral:["ENTP","INFP","ESTP","ISTP"],challenging:["ISFJ","ESFJ","ISTJ","ISFP","ESFP","ESTJ"]},
      INFJ:{excellent:["ENTP","ENFP"],good:["INTJ","INFJ","INTP","ENFJ"],neutral:["INFP","ENTJ","ISFJ","ISTJ"],challenging:["ESTP","ESFP","ISTP","ESFJ","ISFP","ESTJ"]},
      INFP:{excellent:["ENFJ","ENTJ"],good:["INFJ","INTJ","INTP","ENFP"],neutral:["INFP","ENTP","ISFP","ISFJ"],challenging:["ESTP","ESFP","ISTP","ESFJ","ISTJ","ESTJ"]},
      ENFJ:{excellent:["INFP","ISFP"],good:["ENFP","INFJ","ENFJ","INTJ","ENTJ"],neutral:["ENTP","INTP","ESFJ","ISFJ"],challenging:["ESTP","ESFP","ISTP","ISTJ","ESTJ"]},
      ENFP:{excellent:["INTJ","INFJ"],good:["ENTJ","ENTP","ENFJ","INFP"],neutral:["ENFP","INTP","ESFP","ISFP"],challenging:["ISTP","ESTP","ISFJ","ISTJ","ESFJ","ESTJ"]},
      ISTJ:{excellent:["ESFP","ESTP"],good:["ISFJ","ISTJ","ESTJ","ESFJ"],neutral:["INTJ","INTP","INFJ","ISTP"],challenging:["INFP","ENFP","ENFJ","ENTP","ENTJ","ISFP"]},
      ISFJ:{excellent:["ESFP","ESTP"],good:["ISFJ","ESFJ","ISTJ","ESTJ"],neutral:["INFJ","INFP","ENFJ","ISFP"],challenging:["INTJ","INTP","ENTP","ENTJ","ENFP","ISTP"]},
      ESTJ:{excellent:["ISFP","ISTP"],good:["ISTJ","ESFJ","ISFJ","ESTJ"],neutral:["ENTJ","INTP","ESTP","ESFP"],challenging:["INFJ","INFP","ENFJ","ENFP","INTJ","ENTP"]},
      ESFJ:{excellent:["ISFP","ISTP"],good:["ESFJ","ISFJ","ESTJ","ISTJ"],neutral:["ENFJ","ISFP","ESFP","ESTP"],challenging:["INFJ","INFP","ENFP","INTJ","INTP","ENTP","ENTJ"]},
      ISTP:{excellent:["ESFJ","ESTJ"],good:["INTJ","INTP","ESTP","ISTP"],neutral:["ENTJ","ENTP","ISFJ","ISTJ","ISFP"],challenging:["INFJ","INFP","ENFP","ENFJ","ESFP"]},
      ISFP:{excellent:["ENFJ","ESFJ","ESTJ"],good:["ISFJ","ESFP","ISFP"],neutral:["INTJ","INTP","INFP","ENFP","ISTP","ISTJ"],challenging:["INFJ","ENTJ","ENTP","ESTP"]},
      ESTP:{excellent:["ISFJ","ISTJ"],good:["ESFP","ISTP","ESTP","ESFJ"],neutral:["ENTJ","ENTP","INTJ","ESTJ"],challenging:["INFJ","INFP","ENFJ","ENFP","INTP","ISFP"]},
      ESFP:{excellent:["ISFJ","ISTJ"],good:["ESFJ","ESTP","ISFP","ESFP"],neutral:["ENFP","ENFJ","ESTJ"],challenging:["INFJ","INFP","INTJ","INTP","ENTP","ENTJ","ISTP"]}
    };

    // ====== 상태 ======
    let raw = [];       // 원본
    let people = [];    // 정제 후
    let me = null;      // {name, type, isMe:true}
    let layoutMode = "circle"; // circle | grid

    const el = s => document.querySelector(s);
    const els = s => document.querySelectorAll(s);

    // ====== 유틸 ======
    const sleep = ms => new Promise(r=>setTimeout(r, ms));
    const withTimeout = (p, ms=9000) => Promise.race([
      p, new Promise((_,rej)=>setTimeout(()=>rej(new Error("요청 시간초과")), ms))
    ]);

    function normalizeName(n){
      return (n??"").toString().replace(/\s+/g," ").trim();
    }
    function normalizeType(t){
      t = (t??"").toString().toUpperCase().trim();
      return /^[IE][NS][TF][JP]$/.test(t)?t:"";
    }

    function dedupe(list){
      const seen = new Set();
      const out = [];
      for(const r of list){
        const key = `${normalizeName(r.name)}|${normalizeType(r.type)}`;
        if(!seen.has(key) && normalizeType(r.type)){
          seen.add(key);
          out.push({name:normalizeName(r.name), type:normalizeType(r.type)});
        }
      }
      return out;
    }

    function filterPeople(){
      const q = el("#q").value.trim().toLowerCase();
      const f = el("#filterMbti").value;
      return people.filter(p=>{
        const okQ = q ? (p.name?.toLowerCase().includes(q) || p.type.toLowerCase().includes(q)) : true;
        const okF = f ? p.type===f : true;
        return okQ && okF;
      });
    }

    // ====== 데이터 로드 ======
    async function loadData(){
      const btn = el("#btn-load");
      btn.disabled = true;
      btn.textContent = "로딩 중…";
      try{
        const url = SHEET_URL + (SHEET_URL.includes("?")?"&":"?") + "_="+Date.now();
        const res = await withTimeout(fetch(url, {cache:"no-store"}));
        if(!res.ok) throw new Error("스프레드시트 응답 오류");
        const json = await res.json();

        if(!Array.isArray(json)) throw new Error("형식 오류: 배열이 아님");

        // 형식 표준화
        raw = json.map(r=>({name:normalizeName(r.name??r.이름), type:normalizeType(r.type??r.MBTI)}));
        // 정제 & 중복제거
        people = dedupe(raw).slice(0, MAX_NODES);

        render();
        updateStats();
        btn.textContent = "✅ 로드 완료";
        await sleep(800);
        btn.textContent = "👥 관계도 불러오기";
      }catch(e){
        console.error(e);
        alert("데이터 불러오기 실패: " + e.message + "\n웹앱 URL 공개설정/권한을 확인해주세요.");
        btn.textContent = "다시 시도";
      }finally{
        btn.disabled = false;
      }
    }

    // ====== 렌더링 ======
    const stage = el("#stage");
    const wires = el("#wires");

    function render(){
      stage.innerHTML = "";
      wires.innerHTML = "";

      const data = filterPeople();
      const all = me ? [me, ...data] : data;
      if(all.length===0){
        stage.innerHTML = `<div style="position:absolute;inset:0;display:grid;place-items:center;color:#94a3b8">표시할 데이터가 없습니다</div>`;
        setStats("-", "-", me?0:0);
        return;
      }

      const rect = stage.getBoundingClientRect();
      const cx = rect.width/2, cy = rect.height/2;

      // 노드 좌표 계산
      const nodes = [];
      if(layoutMode==="circle"){
        const R = Math.min(cx, cy) * (all.length>10?0.68:0.58);
        all.forEach((p,i)=>{
          const ang = (i/all.length)*Math.PI*2 - Math.PI/2;
          const x = cx + R*Math.cos(ang);
          const y = cy + R*Math.sin(ang);
          nodes.push({p,x,y});
        });
      }else{ // grid
        const cols = Math.ceil(Math.sqrt(all.length));
        const rows = Math.ceil(all.length/cols);
        const pad = 16;
        const cellW = (rect.width - pad*2)/cols;
        const cellH = (rect.height - pad*2)/rows;
        all.forEach((p,i)=>{
          const r = Math.floor(i/cols);
          const c = i%cols;
          const x = pad + c*cellW + cellW/2;
          const y = pad + r*cellH + cellH/2;
          nodes.push({p,x,y});
        });
      }

      // 연결선 (나 기준) or 희미한 전부
      const lines = [];
      if(me){
        const meNode = nodes.find(n=>n.p.isMe);
        nodes.forEach(n=>{
          if(n===meNode) return;
          lines.push(makeLine(meNode, n));
        });
      }else{
        for(let i=0;i<nodes.length;i++){
          for(let j=i+1;j<nodes.length;j++){
            const L = makeLine(nodes[i], nodes[j]);
            L.style.opacity = .15;
            lines.push(L);
          }
        }
      }
      lines.forEach(L=>wires.appendChild(L));

      // 노드
      nodes.forEach(n=>{
        const node = makeNode(n.p);
        const size = n.p.isMe?30:24;
        node.style.left = (n.x - size) + "px";
        node.style.top  = (n.y - size) + "px";
        stage.appendChild(node);
      });
    }

    function makeLine(a,b){
      const level = getLevel(a.p.type, b.p.type);
      const color = ({
        excellent:"#22c55e",
        good:"#3b82f6",
        neutral:"#f59e0b",
        challenging:"#ef4444"
      })[level] || "#94a3b8";

      const dx = b.x - a.x, dy = b.y - a.y;
      const line = document.createElementNS("http://www.w3.org/2000/svg", "line");
      line.setAttribute("x1", a.x); line.setAttribute("y1", a.y);
      line.setAttribute("x2", b.x); line.setAttribute("y2", b.y);
      line.setAttribute("stroke", color);
      line.setAttribute("stroke-width", me?3:2);
      line.setAttribute("data-t1", a.p.type);
      line.setAttribute("data-t2", b.p.type);
      return line;
    }

    function makeNode(p){
      const wrap = document.createElement("div");
      wrap.className = "node";
      wrap.style.position = "absolute";
      wrap.style.display = "flex";
      wrap.style.flexDirection = "column";
      wrap.style.alignItems = "center";
      wrap.style.cursor = "pointer";
      wrap.style.transition = "transform .15s";
      wrap.onpointerdown = e => e.stopPropagation();

      const circle = document.createElement("div");
      circle.style.width = p.isMe?"60px":"50px";
      circle.style.height = p.isMe?"60px":"50px";
      circle.style.borderRadius = "50%";
      circle.style.display = "grid";
      circle.style.placeItems = "center";
      circle.style.fontSize = p.isMe?"26px":"22px";
      circle.style.background = `linear-gradient(135deg, ${mbtiColor[p.type]||"#ddd"}, ${(mbtiColor[p.type]||"#ddd")}dd)`;
      circle.style.border = p.isMe ? "3px solid gold":"2px solid #fff";
      circle.style.boxShadow = p.isMe ? "0 0 15px rgba(255,215,0,.5)":"0 4px 12px rgba(0,0,0,.12)";
      if(p.isMe){
        circle.style.animation = "pulse 2s infinite";
      }
      circle.textContent = mbtiEmojis[p.type]||"❓";

      const label = document.createElement("div");
      label.textContent = p.type;
      label.style.marginTop = "4px";
      label.style.padding = "2px 8px";
      label.style.borderRadius = "999px";
      label.style.background = "#fff";
      label.style.fontSize = "12px";
      label.style.fontWeight = "800";
      label.style.color = mbtiColor[p.type]||"#334155";
      label.style.boxShadow = "0 2px 6px rgba(0,0,0,.08)";

      const name = document.createElement("div");
      name.textContent = p.name || (p.isMe?"나":"");
      name.style.marginTop = "2px";
      name.style.fontSize = "11px";
      name.style.color = "#475569";
      name.style.maxWidth = "84px";
      name.style.whiteSpace = "nowrap";
      name.style.overflow = "hidden";
      name.style.textOverflow = "ellipsis";

      wrap.appendChild(circle);
      wrap.appendChild(label);
      if(name.textContent) wrap.appendChild(name);

      wrap.addEventListener("click", ()=>{
        highlight(p);
        openSheet(p);
      });

      return wrap;
    }

    function getLevel(t1, t2){
      const m = comp[t1];
      if(!m) return "neutral";
      if(m.excellent.includes(t2)) return "excellent";
      if(m.good.includes(t2)) return "good";
      if(m.challenging.includes(t2)) return "challenging";
      return "neutral";
    }

    function highlight(target){
      // 노드 확대 효과는 CSS로 간단 처리(선택된 노드만 확대가 필요하면 dataset 사용)
      // 연결선 하이라이트
      [...wires.querySelectorAll("line")].forEach(L=>{
        const t1 = L.getAttribute("data-t1");
        const t2 = L.getAttribute("data-t2");
        const on = me
          ? (target.isMe ? (t1===me.type || t2===me.type) : ( (t1===me.type && t2===target.type) || (t2===me.type && t1===target.type) ))
          : (t1===target.type || t2===target.type);
        L.setAttribute("stroke-opacity", on?1:.15);
        L.setAttribute("stroke-width", on?4: (me?3:2));
      });
    }

    // ====== 상세 바텀시트 ======
    const sheetEl = el("#sheet");
    function openSheet(p){
      const title = el("#sheetTitle");
      const body = el("#sheetBody");
      title.textContent = `${mbtiEmojis[p.type]||"❓"} ${p.name || p.type}`;
      if(me && !p.isMe){
        const level = getLevel(me.type, p.type);
        const label = ({
          excellent:"💚 최고의 궁합",
          good:"💙 좋은 궁합",
          neutral:"💛 보통",
          challenging:"🧡 도전적"
        })[level];
        body.innerHTML = `
          <div style="margin-bottom:10px"><b>${me.type} ↔ ${p.type}</b></div>
          <div style="font-size:16px;margin-bottom:12px">${label}</div>
          <div style="font-size:13px;line-height:1.7">
            <b>관계 팁</b><br/>
            ${relationTip(level)}
          </div>`;
      }else{
        const m = comp[p.type]||{excellent:[],good:[],neutral:[],challenging:[]};
        body.innerHTML = `
          <div style="display:grid;gap:6px;font-size:13px">
            <div>💚 <b>최고</b> : ${m.excellent.join(", ")||"-"}</div>
            <div>💙 <b>좋음</b> : ${m.good.join(", ")||"-"}</div>
            <div>💛 <b>보통</b> : ${m.neutral.join(", ")||"-"}</div>
            <div>🧡 <b>도전적</b> : ${m.challenging.join(", ")||"-"}</div>
          </div>`;
      }
      sheetEl.classList.add("show");
    }
    function relationTip(level){
      switch(level){
        case "excellent": return "서로의 부족한 부분을 자연스럽게 채워주니 속도와 품질을 동시에 노리세요. 빠른 합의와 역할 분담이 잘 맞습니다.";
        case "good": return "가벼운 브리핑과 정기 싱크로 충분합니다. 의사결정 기록만 남기면 실행력이 좋아집니다.";
        case "neutral": return "용어·기준이 달라 생기는 오해를 먼저 줄이세요. 정의(Definition) 정렬 → 일정 합의 순이 좋습니다.";
        case "challenging": return "목표-기준-역할을 문서로 고정하세요. 감정 대신 데이터·산출물로 소통하면 성장의 발판이 됩니다.";
        default: return "상대의 강점을 먼저 인정하고 공통 목표를 명료하게 두면 대부분의 문제가 정리됩니다.";
      }
    }
    el("#sheetClose").addEventListener("click", ()=> sheetEl.classList.remove("show"));
    document.addEventListener("click",(e)=>{
      if(!e.target.closest("#sheet") && !e.target.closest(".node")){
        sheetEl.classList.remove("show");
        // 연결선 원복
        [...wires.querySelectorAll("line")].forEach(L=>{
          L.setAttribute("stroke-opacity", me?1:.15);
          L.setAttribute("stroke-width", me?3:2);
        });
      }
    });

    // ====== 통계 ======
    function updateStats(){
      const data = filterPeople();
      const total = data.length;
      if(me){
        const ex = data.filter(p=>comp[me.type]?.excellent.includes(p.type)).length;
        const ch = data.filter(p=>comp[me.type]?.challenging.includes(p.type)).length;
        setStats(ex, ch, total);
      }else{
        setStats("-", "-", total);
      }
    }
    function setStats(ex, ch, total){
      el("#excellentCount").textContent = ex;
      el("#challengingCount").textContent = ch;
      el("#totalCount").textContent = total;
    }

    // ====== 이벤트 ======
    el("#btn-load").addEventListener("click", loadData);
    el("#btn-reset").addEventListener("click", ()=>{
      el("#q").value = "";
      el("#filterMbti").value = "";
      me=null; render(); updateStats();
    });
    el("#btn-me").addEventListener("click", ()=>{
      const name = normalizeName(el("#myName").value);
      const type = normalizeType(el("#myMbti").value);
      if(!type){ alert("내 MBTI를 선택하세요."); return; }
      me = {name: name || "나", type, isMe:true};
      render(); updateStats();
    });
    el("#q").addEventListener("input", ()=>{ render(); updateStats(); });
    el("#filterMbti").addEventListener("change", ()=>{ render(); updateStats(); });

    // 배치 전환
    el("#mode-circle").addEventListener("click", ()=>{
      layoutMode="circle";
      el("#mode-circle").classList.add("active");
      el("#mode-grid").classList.remove("active");
      render();
    });
    el("#mode-grid").addEventListener("click", ()=>{
      layoutMode="grid";
      el("#mode-grid").classList.add("active");
      el("#mode-circle").classList.remove("active");
      render();
    });

    // 반응형 리드로우
    let ro = new ResizeObserver(()=> render());
    ro.observe(el(".viz-wrap"));

    // 초기 자동 로드
    window.addEventListener("load", loadData);

    // 키보드 접근성(검색 포커스 시 ESC로 지우기)
    document.addEventListener("keydown",(e)=>{
      if(e.key==="Escape" && document.activeElement===el("#q")){
        el("#q").value=""; render(); updateStats();
      }
    });
  </script>

  <style>
    @keyframes pulse {0%,100%{transform:scale(1)}50%{transform:scale(1.05)}}
  </style>
</body>
</html>
