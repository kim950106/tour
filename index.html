<script>
  // âœ… ì›¹ì•± URL
  const SHEET_URL = "https://script.google.com/macros/s/AKfycbxgPR8R0tD-eLfWV2tLcaI4SF9sCMh6tJhlYls4Yfzp84EbnoJEhJNShlmTHRqpTb-C/exec";

  const state = {
    members: [],
    relations: [],
    mode: "graph", // graph | list
  };

  const elStage = document.getElementById("stage");
  const elListView = document.getElementById("listView");
  const elRelationList = document.getElementById("relationList");
  const elBtnLoad = document.getElementById("btn-load");
  const elBtnReset = document.getElementById("btn-reset");
  const elBtnListClose = document.getElementById("btnListClose");
  const elQ = document.getElementById("q");
  const elFilterMbti = document.getElementById("filterMbti");
  const elStatTotal = document.getElementById("statTotal");
  const elStatOk = document.getElementById("statOk");
  const elStatWarn = document.getElementById("statWarn");
  const elBtnModeGraph = document.getElementById("btnModeGraph");
  const elBtnModeList = document.getElementById("btnModeList");

  function setMode(mode){
    state.mode = mode;
    if(mode === "graph"){
      elStage.style.display = "block";
      elListView.classList.remove("show");
      elBtnModeGraph.classList.add("active");
      elBtnModeList.classList.remove("active");
    }else{
      elStage.style.display = "none";
      elListView.classList.add("show");
      elBtnModeGraph.classList.remove("active");
      elBtnModeList.classList.add("active");
    }
  }

  elBtnModeGraph.addEventListener("click", ()=> setMode("graph"));
  elBtnModeList.addEventListener("click", ()=> setMode("list"));
  elBtnListClose.addEventListener("click", ()=> setMode("graph"));

  // âœ… MBTI ê¶í•© ê°„ë‹¨ ê·œì¹™
  function getRelationLevel(m1, m2){
    const a = (m1.mbti || "").toUpperCase();
    const b = (m2.mbti || "").toUpperCase();
    if(a.length !== 4 || b.length !== 4) return "warn";

    if(a === b) return "ok"; // ê°™ì€ ìœ í˜•ì€ ì¹œë°€ê° ë†’ìŒ

    let score = 0;
    if(a[1] === b[1]) score++; // N/S
    if(a[2] === b[2]) score++; // F/T
    if(a[3] === b[3]) score++; // J/P

    if(score >= 2) return "ok";   // ë¹„ìŠ·í•œ ì„±í–¥ ë§ìŒ
    if(score === 1) return "warn";
    return "bad";
  }

  function buildRelationsFromMbti(){
    const members = state.members;
    const rels = [];
    for(let i=0;i<members.length;i++){
      for(let j=i+1;j<members.length;j++){
        const level = getRelationLevel(members[i], members[j]);
        rels.push({from: members[i].id, to: members[j].id, level});
      }
    }
    state.relations = rels;
  }

  // âœ… ì›¹ì•±ì—ì„œ ì‹¤ì œ ë°ì´í„° ê°€ì ¸ì˜¤ê¸°
  elBtnLoad.addEventListener("click", async () => {
    try{
      const res = await fetch(SHEET_URL, {
        method: "GET",
        mode: "cors",
      });
      if(!res.ok){
        throw new Error("ì‘ë‹µ ì½”ë“œ: " + res.status);
      }
      const json = await res.json();
      console.log("ì›¹ì•± ì‘ë‹µ:", json);

      let members = [];

      // { members:[{name, mbti}, ...] } êµ¬ì¡°ë¼ê³  ê°€ì •
      if(Array.isArray(json.members)){
        members = json.members;
      }else if(Array.isArray(json)){
        // í˜¹ì‹œ ê·¸ëƒ¥ ë°°ì—´ë§Œ ë‚´ë ¤ì£¼ë©´
        members = json;
      }

      members = members
        .filter(m => m && (m.name || m.ì´ë¦„))
        .map((m, idx) => ({
          id: m.id ?? (idx + 1),
          name: m.name ?? m.ì´ë¦„,                       // Aì—´
          mbti: (m.mbti ?? m.MBTI ?? "").toUpperCase() // Bì—´
        }));

      state.members = members;
      buildRelationsFromMbti(); // ğŸ”¥ MBTIë¡œ ê´€ê³„ ìë™ ê³„ì‚°
      updateStats();
      renderList();
      setMode("graph");

      alert("MBTI ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì™”ìŠµë‹ˆë‹¤. ìƒë‹¨ì—ì„œ â€˜ë¦¬ìŠ¤íŠ¸â€™ë¥¼ ëˆŒëŸ¬ ì´ë¦„Â·MBTI ê¸°ì¤€ ê´€ê³„ë¥¼ í™•ì¸í•˜ì„¸ìš”.");
    }catch(err){
      console.error(err);
      alert("ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.\në¸Œë¼ìš°ì € ê°œë°œì ë„êµ¬(F12) â†’ ì½˜ì†”ì—ì„œ ì—ëŸ¬ë¥¼ í™•ì¸í•´ ì£¼ì„¸ìš”.");
    }
  });

  elBtnReset.addEventListener("click", () => {
    elQ.value = "";
    elFilterMbti.value = "";
    state.members = [];
    state.relations = [];
    elRelationList.innerHTML = '<div class="muted">ë°ì´í„°ê°€ ì´ˆê¸°í™”ë˜ì—ˆìŠµë‹ˆë‹¤.</div>';
    updateStats();
    setMode("graph");
  });

  elQ.addEventListener("input", () => {
    if(state.members.length === 0) return;
    renderList();
  });
  elFilterMbti.addEventListener("change", () => {
    if(state.members.length === 0) return;
    renderList();
  });

  function updateStats(){
    const total = state.members.length;
    let ok = 0, warnOrBad = 0;
    state.relations.forEach(r => {
      if(r.level === "ok") ok++;
      else warnOrBad++;
    });
    elStatTotal.textContent = total;
    elStatOk.textContent = ok;
    elStatWarn.textContent = warnOrBad;
  }

  function renderList(){
    const q = elQ.value.trim().toLowerCase();
    const mbtiFilter = elFilterMbti.value;

    if(state.members.length === 0){
      elRelationList.innerHTML = '<div class="muted">ë¶ˆëŸ¬ì˜¨ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.</div>';
      return;
    }

    const filtered = state.members.filter(m => {
      const nameText = (m.name || "").toLowerCase();
      const mbtiText = (m.mbti || "").toLowerCase();
      const matchText = !q || nameText.includes(q) || mbtiText.includes(q);
      const matchMbti = mbtiFilter ? m.mbti === mbtiFilter : true;
      return matchText && matchMbti;
    });

    if(filtered.length === 0){
      elRelationList.innerHTML =
        '<div class="muted">ê²€ìƒ‰/í•„í„°ì— í•´ë‹¹í•˜ëŠ” ì¸ì›ì´ ì—†ìŠµë‹ˆë‹¤.</div>';
      return;
    }

    const items = filtered.map(m => {
      const rels = state.relations.filter(
        r => r.from === m.id || r.to === m.id
      );
      let ok = 0, warn = 0, bad = 0;
      rels.forEach(r => {
        if(r.level === "ok") ok++;
        else if(r.level === "warn") warn++;
        else if(r.level === "bad") bad++;
      });

      return `
        <div class="rel-item">
          <div class="rel-top">
            <div class="rel-name">${m.name}</div>
            <div class="rel-mbti">${m.mbti}</div>
          </div>
          <div class="rel-summary">
            <span class="badge ok">ğŸ‘ ì˜ ë§ëŠ” ê´€ê³„ ${ok}ëª…</span>
            <span class="badge warn">âš ï¸ ì£¼ì˜ ê´€ê³„ ${warn}ëª…</span>
            <span class="badge bad">ğŸ’¥ ì¶©ëŒ ê´€ê³„ ${bad}ëª…</span>
          </div>
        </div>
      `;
    }).join("");

    elRelationList.innerHTML = items;
  }

  // ì´ˆê¸° ìƒíƒœ
  setMode("graph");
  elStage.innerHTML = '<div class="muted" style="position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);font-size:13px;">ê´€ê³„ë„ ì˜ì—­ (ê·¸ë˜í”„ ë Œë”ë§ ì˜ˆì •)</div>';
</script>
