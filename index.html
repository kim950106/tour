<script>
  // âœ… Apps Script ì›¹ì•± URL (exec ì£¼ì†Œ)
  const API_URL = "https://script.google.com/macros/s/AKfycbxgPR8R0tD-eLfWV2tLcaI4SF9sCMh6tJhlYls4Yfzp84EbnoJEhJNShlmTHRqpTb-C/exec";

  // ğŸ”™ ëŒì•„ê°€ê¸° ì•„ì´ì½˜ â†’ ë§í¬ ì´ë™
  document.getElementById("btnBack").addEventListener("click", () => {
    window.location.href = "https://kim950106.github.io/travel-recommendation/";
  });

  const btnRun = document.getElementById('btnRun');
  const nameInput = document.getElementById('nameInput');
  const mbtiInput = document.getElementById('mbtiInput');
  const targetInfo = document.getElementById('targetInfo');
  const content = document.getElementById('content');

  // JS ìª½ì—ì„œë„ MBTI ê¶í•© ê³„ì‚° í•¨ìˆ˜ í•˜ë‚˜ ê°€ì§€ê³  ìˆê²Œ
  function jsRelationLevel(target, other){
    if(!target || !other) return "normal";
    const a = String(target).toUpperCase();
    const b = String(other).toUpperCase();
    if(a.length !== 4 || b.length !== 4) return "normal";
    if(a === b) return "good";
    let score = 0;
    if(a[1] === b[1]) score++;
    if(a[2] === b[2]) score++;
    if(a[3] === b[3]) score++;
    if(score >= 2) return "good";
    if(score === 1) return "normal";
    return "effort";
  }

  // ğŸ”§ ì–´ë–¤ í˜•íƒœì˜ JSONì´ ì™€ë„ {targetName, targetMbti, groups} ë¡œ ë§ì¶°ì£¼ëŠ” ì •ê·œí™”
  function normalizeData(raw, fallbackName, fallbackMbti){
    // 1) ê¸°ë³¸ ê°’
    let targetName = raw.targetName || fallbackName || "";
    let targetMbti = (raw.targetMbti || fallbackMbti || "").toUpperCase();
    let groups = raw.groups;

    // 2) groups ì—†ê³ , members ë°°ì—´ë§Œ ì˜¨ ê²½ìš° â†’ ì—¬ê¸°ì„œ ì§ì ‘ ê·¸ë£¹ ê³„ì‚°
    if(!groups && Array.isArray(raw.members)){
      const members = raw.members
        .map((m,idx) => ({
          id: m.id ?? (idx+1),
          name: m.name || m.ì´ë¦„ || "",
          mbti: (m.mbti || m.MBTI || "").toUpperCase()
        }))
        .filter(m => m.name && m.mbti);

      // íƒ€ê²Ÿ MBTIê°€ ì—†ê³ , ì´ë¦„ì€ ìˆëŠ” ê²½ìš° â†’ ì‹œíŠ¸ì—ì„œ ì°¾ì•„ì„œ ì„¤ì •
      if(!targetMbti && targetName){
        const found = members.find(m => m.name === targetName);
        if(found) targetMbti = found.mbti;
      }
      // ë‘˜ ë‹¤ ì—†ìœ¼ë©´ ê·¸ëƒ¥ ì²« ì‚¬ëŒ MBTIë¥¼ ê¸°ì¤€ìœ¼ë¡œë¼ë„ ë³´ì—¬ì£¼ê¸°
      if(!targetMbti && members.length > 0){
        targetMbti = members[0].mbti;
      }

      const map = {good:{}, normal:{}, effort:{}};

      members.forEach(m => {
        const level = jsRelationLevel(targetMbti, m.mbti);
        const bucket = map[level];
        if(!bucket[m.mbti]) bucket[m.mbti] = [];
        bucket[m.mbti].push(m.name);
      });

      const toArr = obj => Object.keys(obj).sort().map(mbti => ({
        mbti,
        names: obj[mbti]
      }));

      groups = {
        good: toArr(map.good),
        normal: toArr(map.normal),
        effort: toArr(map.effort)
      };
    }

    // 3) ê·¸ë˜ë„ groupsê°€ ì—†ìœ¼ë©´ ë¹ˆ í‹€ì´ë¼ë„
    if(!groups){
      groups = {good:[], normal:[], effort:[]};
    }

    return {
      targetName,
      targetMbti,
      groups
    };
  }

  function renderRelations(rawData){
    const data = normalizeData(
      rawData,
      nameInput.value.trim(),
      mbtiInput.value.trim()
    );

    if (rawData.error && !data.targetMbti){
      targetInfo.textContent = rawData.error;
      content.innerHTML = '<div class="empty">'+ rawData.error +'</div>';
      return;
    }

    if(!data.targetMbti){
      targetInfo.textContent = 'MBTIë¥¼ ì•Œ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ì´ë¦„ ë˜ëŠ” MBTIë¥¼ í™•ì¸í•´ ì£¼ì„¸ìš”.';
      content.innerHTML = '<div class="empty">MBTI ì •ë³´ê°€ ì—†ì–´ ê´€ê³„ë„ë¥¼ ë§Œë“¤ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</div>';
      return;
    }

    targetInfo.textContent =
      (data.targetName ? data.targetName + ' / ' : '') +
      'MBTI: ' + data.targetMbti + ' ê¸°ì¤€ ê´€ê³„ë„';

    const groups = data.groups || {good:[], normal:[], effort:[]};

    function renderSection(title, sub, cssClass, items){
      if (!items || items.length === 0){
        return `
          <section class="section ${cssClass}">
            <div class="sec-title">${title}</div>
            <div class="sec-sub">${sub}</div>
            <div class="empty">í•´ë‹¹ë˜ëŠ” MBTIê°€ ì—†ìŠµë‹ˆë‹¤.</div>
          </section>
        `;
      }

      const rows = items.map(item => {
        const names = item.names || [];
        const chipLabel = item.mbti;
        const count = names.length;
        const namesStr = names.join(', ');
        const dataNames = encodeURIComponent(namesStr);

        return `
          <div class="mbti-row">
            <div class="mbti-label">${chipLabel}</div>
            <div class="chip-wrap">
              <button class="chip"
                      data-names="${dataNames}">
                ${chipLabel}
                <span class="count">${count}ëª…</span>
              </button>
            </div>
          </div>
        `;
      }).join('');

      return `
        <section class="section ${cssClass}">
          <div class="sec-title">${title}</div>
          <div class="sec-sub">${sub}</div>
          ${rows}
        </section>
      `;
    }

    const html = [
      renderSection('ì¢‹ìŒ', 'ì‹œë„ˆì§€ê°€ ë†’ì€ ìœ í˜•', 'sec-good', groups.good),
      renderSection('ë³´í†µ', 'ìƒí™©ì— ë”°ë¼ ë‹¤ë¥¸ ìœ í˜•', 'sec-normal', groups.normal),
      renderSection('ë…¸ë ¥ í•„ìš”', 'ì˜ì‚¬ì†Œí†µ ì£¼ì˜ í•„ìš”í•œ ìœ í˜•', 'sec-effort', groups.effort),
    ].join('');

    content.innerHTML = html;

    // MBTI ì¹© í´ë¦­ â†’ ì´ë¦„ íŒì—…
    content.querySelectorAll('.chip').forEach(chip => {
      chip.addEventListener('click', () => {
        const namesStr = decodeURIComponent(chip.dataset.names || '');
        if (!namesStr){
          alert('í•´ë‹¹ MBTI ì¸ì›ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
          return;
        }
        alert('í•´ë‹¹ MBTI ì¸ì›:\n\n' + namesStr);
      });
    });
  }

  // ğŸ”¥ ë²„íŠ¼ í´ë¦­ ì‹œ Apps Script API í˜¸ì¶œ
  btnRun.addEventListener('click', async () => {
    const name = nameInput.value.trim();
    const mbti = mbtiInput.value.trim();

    targetInfo.textContent = 'ê´€ê³„ë„ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ì…ë‹ˆë‹¤...';

    try{
      const url = API_URL
        + '?name=' + encodeURIComponent(name)
        + '&mbti=' + encodeURIComponent(mbti);

      const res = await fetch(url);
      if(!res.ok){
        throw new Error('HTTP ' + res.status);
      }
      const data = await res.json();
      console.log('API ì‘ë‹µ:', data);
      renderRelations(data);
    }catch(err){
      console.error(err);
      targetInfo.textContent = 'ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.';
      content.innerHTML = '<div class="empty">ì„œë²„ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.</div>';
    }
  });
</script>
